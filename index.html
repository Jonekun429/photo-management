<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Smart Cleaner</title>
    <style>
        :root{--bg:#060F0D;--sf:#0E1E1A;--sf2:#163028;--tx:#E8F1EE;--tx2:#6B8A82;--tx3:#3E5D54;--ac:#005D4D;--ac2:#00A67E;--red:#E5484D;--amb:#F5A623;--r:16px;--r2:12px}
        *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
        body{font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;background:#000;display:flex;justify-content:center;-webkit-font-smoothing:antialiased}
        #app{width:100%;max-width:430px;height:100dvh;background:var(--bg);color:var(--tx);display:flex;flex-direction:column;overflow:hidden;position:relative}

        /* Header */
        .hd{padding:54px 20px 12px;flex-shrink:0;background:var(--bg);z-index:10}
        .hd-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
        .hd-back{color:var(--ac2);font-size:17px;font-weight:500;cursor:pointer;display:none;padding:6px 0}
        .hd-back:active{opacity:.5}
        .hd-right{display:flex;gap:8px;align-items:center}
        .hd-pill{background:var(--sf);color:var(--tx);border:1px solid rgba(0,93,77,.15);border-radius:20px;padding:7px 14px;font-size:12px;font-weight:600;cursor:pointer;display:none}
        .hd-pill:active{background:var(--sf2)}
        .hd h1{font-size:32px;font-weight:700;letter-spacing:-.5px}
        .hd-sub{font-size:13px;color:var(--tx2);margin-top:2px;display:none}

        /* Scrollable area */
        .page{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;display:none;padding:0 20px 120px}
        .page::-webkit-scrollbar{display:none}
        .page.on{display:block;animation:fadeUp .25s ease}
        @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

        /* === HOME === */
        .meter{margin:8px 0 24px}
        .meter-row{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px}
        .meter-val{font-size:14px;font-weight:600}
        .meter-val span{color:var(--ac2)}
        .meter-pct{font-size:12px;font-weight:700;color:var(--amb);background:rgba(245,166,35,.1);padding:3px 8px;border-radius:6px}
        .meter-bar{height:4px;background:rgba(255,255,255,.04);border-radius:2px;overflow:hidden}
        .meter-fill{height:100%;background:linear-gradient(90deg,var(--ac),var(--ac2));border-radius:2px;transition:width 1s ease}

        /* Category cards */
        .cats{display:flex;flex-direction:column;gap:12px}
        .cat{background:var(--sf);border:1px solid rgba(0,93,77,.08);border-radius:var(--r);padding:16px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all .15s}
        .cat:active{background:var(--sf2);transform:scale(.98)}
        .cat-icon{width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
        .cat-icon.sim{background:rgba(0,93,77,.15)}
        .cat-icon.ss{background:rgba(245,166,35,.12)}
        .cat-icon.vid{background:rgba(88,166,255,.12)}
        .cat-icon.big{background:rgba(229,72,77,.1)}
        .cat-info{flex:1;min-width:0}
        .cat-name{font-size:15px;font-weight:600;margin-bottom:2px}
        .cat-desc{font-size:12px;color:var(--tx2)}
        .cat-size{font-size:16px;font-weight:700;color:var(--ac2);text-align:right;white-space:nowrap}
        .cat-arrow{color:var(--tx3);font-size:18px;margin-left:4px}
        .cat .cat-badge{background:var(--red);color:#fff;font-size:10px;font-weight:700;padding:2px 7px;border-radius:10px;margin-left:6px}

        /* Scan CTA */
        .scan-cta{margin-top:24px;background:var(--sf);border:1px dashed rgba(0,93,77,.25);border-radius:var(--r);padding:24px 20px;text-align:center}
        .scan-cta h3{font-size:16px;font-weight:600;margin-bottom:6px}
        .scan-cta p{font-size:12px;color:var(--tx2);line-height:1.5;margin-bottom:16px}
        .scan-btns{display:flex;flex-direction:column;gap:8px}
        .s-btn{width:100%;padding:13px;border:none;border-radius:var(--r2);font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .15s}
        .s-btn:active{transform:scale(.97)}
        .s-btn.pri{background:linear-gradient(135deg,var(--ac),var(--ac2));color:#fff;box-shadow:0 4px 16px rgba(0,93,77,.25)}
        .s-btn.sec{background:rgba(0,93,77,.1);color:var(--ac2);border:1px solid rgba(0,93,77,.2)}
        .scan-status{margin-top:12px;display:none;text-align:left;padding:12px;background:rgba(0,166,126,.06);border:1px solid rgba(0,166,126,.12);border-radius:var(--r2)}
        .scan-status.on{display:block}
        .scan-status p{font-size:12px;color:var(--ac2);display:flex;align-items:center;gap:6px}
        .scan-status p::before{content:'';width:6px;height:6px;background:var(--ac2);border-radius:50%;flex-shrink:0}

        /* === DETAIL VIEWS === */
        /* Grid */
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .grid-3{grid-template-columns:1fr 1fr 1fr;gap:6px}
        .item{position:relative;border-radius:var(--r2);overflow:hidden;cursor:pointer;background:var(--sf);transition:all .2s}
        .item img{width:100%;aspect-ratio:1;object-fit:cover;display:block;transition:filter .2s}
        .item.on{outline:2.5px solid var(--red);outline-offset:-2.5px;border-radius:var(--r2)}
        .item.on img{filter:brightness(.6)}
        .item .ck{position:absolute;bottom:6px;right:6px;width:22px;height:22px;border:2px solid rgba(255,255,255,.5);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:transparent;background:rgba(0,0,0,.3);backdrop-filter:blur(4px);z-index:2;transition:all .2s}
        .item.on .ck{background:var(--red);border-color:var(--red);color:#fff}
        .item .tag{position:absolute;top:6px;left:6px;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);color:#fff;font-size:10px;font-weight:600;padding:2px 7px;border-radius:5px;z-index:2}
        .item .sz{position:absolute;bottom:6px;left:6px;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);color:#fff;font-size:11px;font-weight:600;padding:3px 7px;border-radius:6px;z-index:2}

        /* Similar Photo Group */
        .grp{margin-bottom:20px}
        .grp-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding:0 2px}
        .grp-title{font-size:13px;font-weight:600;color:var(--tx2)}
        .grp-btn{font-size:12px;color:var(--ac2);font-weight:600;cursor:pointer;padding:4px 0}
        .grp-btn:active{opacity:.5}
        .grp .item:first-child::after{content:'ãƒ™ã‚¹ãƒˆ';position:absolute;top:6px;right:6px;background:rgba(0,93,77,.85);color:var(--ac2);font-size:9px;font-weight:700;padding:3px 7px;border-radius:5px;z-index:3;letter-spacing:.5px}

        /* Play icon for videos */
        .item .play{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:32px;height:32px;background:rgba(0,0,0,.5);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;z-index:2}

        /* === BOTTOM BAR === */
        .bot{position:absolute;bottom:0;left:0;width:100%;z-index:30;padding:0 16px 28px;pointer-events:none}
        .bot-del{width:100%;padding:15px;background:var(--red);color:#fff;border:none;border-radius:var(--r2);font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transform:translateY(80px);transition:transform .3s cubic-bezier(.25,.8,.25,1);pointer-events:all;box-shadow:0 6px 24px rgba(229,72,77,.3)}
        .bot-del.show{transform:translateY(0)}
        .bot-del:active{transform:translateY(0) scale(.97)}

        /* === SCAN OVERLAY === */
        .overlay{position:absolute;inset:0;background:var(--bg);z-index:200;display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:40px}
        .overlay.on{display:flex}
        .spinner{width:56px;height:56px;border:2.5px solid rgba(0,93,77,.2);border-top-color:var(--ac2);border-radius:50%;animation:spin .8s linear infinite;margin-bottom:24px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .overlay h3{font-size:18px;font-weight:600;margin-bottom:6px}
        .overlay .o-sub{font-size:13px;color:var(--tx2);margin-bottom:20px;min-height:20px}
        .o-bar{width:200px;height:3px;background:rgba(255,255,255,.06);border-radius:2px;overflow:hidden}
        .o-fill{height:100%;background:var(--ac2);border-radius:2px;width:0;transition:width .2s}
        .o-stats{display:flex;gap:20px;margin-top:24px}
        .o-stat{text-align:center}
        .o-stat b{display:block;font-size:22px;color:var(--ac2)}
        .o-stat span{font-size:10px;color:var(--tx2)}

        /* === TOAST === */
        .toast{position:absolute;top:52px;left:16px;right:16px;background:var(--sf);border:1px solid rgba(0,93,77,.2);border-radius:var(--r2);padding:12px 14px;display:flex;justify-content:space-between;align-items:center;z-index:100;box-shadow:0 12px 40px rgba(0,0,0,.5);transform:translateY(-120%);transition:transform .35s cubic-bezier(.25,.8,.25,1)}
        .toast.show{transform:translateY(0)}
        .toast span{font-size:12.5px}.toast strong{color:var(--red)}
        .toast button{background:none;border:none;color:var(--ac2);font-size:12.5px;font-weight:700;cursor:pointer}

        /* === MODAL === */
        .modal{position:absolute;inset:0;background:rgba(0,0,0,.5);z-index:150;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s}
        .modal.on{opacity:1;pointer-events:all}
        .modal-box{width:100%;max-width:430px;background:var(--sf);border-radius:20px 20px 0 0;padding:20px 20px 36px;transform:translateY(100%);transition:transform .3s cubic-bezier(.25,.8,.25,1)}
        .modal.on .modal-box{transform:translateY(0)}
        .modal-box h3{font-size:16px;font-weight:700;text-align:center;margin-bottom:4px}
        .modal-box p{font-size:12.5px;color:var(--tx2);text-align:center;margin-bottom:20px;line-height:1.5}
        .modal-btn{width:100%;padding:14px;border:none;border-radius:var(--r2);font-size:14px;font-weight:700;cursor:pointer;margin-bottom:8px}
        .modal-btn:active{transform:scale(.97)}
        .modal-btn.danger{background:var(--red);color:#fff}
        .modal-btn.cancel{background:rgba(255,255,255,.06);color:var(--tx)}

        .file-in{display:none}
    </style>
</head>
<body>
<div id="app">
    <div class="hd">
        <div class="hd-row">
            <div class="hd-back" id="hd-back" onclick="go('home')">â† æˆ»ã‚‹</div>
            <div class="hd-right">
                <div class="hd-pill" id="sel-btn" onclick="toggleAll()">ã™ã¹ã¦é¸æŠ</div>
            </div>
        </div>
        <h1 id="hd-title">Smart Cleaner</h1>
        <div class="hd-sub" id="hd-sub"></div>
    </div>

    <!-- HOME -->
    <div class="page on" id="p-home">
        <div class="meter">
            <div class="meter-row">
                <div class="meter-val"><span id="m-used">0</span> ä½¿ç”¨ä¸­</div>
                <div class="meter-pct" id="m-pct">0%</div>
            </div>
            <div class="meter-bar"><div class="meter-fill" id="m-fill" style="width:0"></div></div>
        </div>

        <div class="cats" id="cat-list">
            <div class="cat" onclick="go('similar')">
                <div class="cat-icon sim">ğŸ–¼</div>
                <div class="cat-info"><div class="cat-name">ä¼¼ã¦ã„ã‚‹å†™çœŸ</div><div class="cat-desc">é‡è¤‡ãƒ»é¡ä¼¼ã‚’è‡ªå‹•æ¤œå‡º</div></div>
                <div class="cat-size" id="c-sim">â€”</div>
                <div class="cat-arrow">â€º</div>
            </div>
            <div class="cat" onclick="go('ss')">
                <div class="cat-icon ss">ğŸ“±</div>
                <div class="cat-info"><div class="cat-name">ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ</div><div class="cat-desc">ä¸è¦ãªã‚¹ã‚¯ã‚·ãƒ§ã‚’ä¸€æ‹¬æ•´ç†</div></div>
                <div class="cat-size" id="c-ss">â€”</div>
                <div class="cat-arrow">â€º</div>
            </div>
            <div class="cat" onclick="go('vid')">
                <div class="cat-icon vid">ğŸ¬</div>
                <div class="cat-info"><div class="cat-name">å¤§ããªå‹•ç”»</div><div class="cat-desc">å®¹é‡ã®å¤§ãã„å‹•ç”»ã‚’ç™ºè¦‹</div></div>
                <div class="cat-size" id="c-vid">â€”</div>
                <div class="cat-arrow">â€º</div>
            </div>
            <div class="cat" onclick="go('big')">
                <div class="cat-icon big">ğŸ“</div>
                <div class="cat-info"><div class="cat-name">å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«</div><div class="cat-desc">RAWãƒ»å¤§ããªå†™çœŸã‚’æ¤œå‡º</div></div>
                <div class="cat-size" id="c-big">â€”</div>
                <div class="cat-arrow">â€º</div>
            </div>
        </div>

        <div class="scan-cta" id="scan-cta">
            <h3>ğŸ“‚ å†™çœŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¹ã‚­ãƒ£ãƒ³</h3>
            <p>ãƒ•ã‚©ãƒ«ãƒ€ã‚’è¨±å¯ã—ã¦ä¸€æ‹¬èª­ã¿è¾¼ã¿ã€<br>ã¾ãŸã¯å€‹åˆ¥ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã§ãã¾ã™</p>
            <div class="scan-btns">
                <button class="s-btn pri" onclick="doFolder()">ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>
                <button class="s-btn sec" onclick="doFiles()">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
            </div>
        </div>
        <div class="scan-status" id="scan-ok"><p id="scan-ok-txt">èª­ã¿è¾¼ã¿æ¸ˆã¿</p></div>
        <input type="file" id="inp-folder" class="file-in" multiple>
        <input type="file" id="inp-files" class="file-in" accept="image/*,video/*,.cr2,.nef,.arw,.dng,.orf,.rw2" multiple>
    </div>

    <!-- SIMILAR -->
    <div class="page" id="p-similar"><div id="sim-list"></div><div class="empty" id="sim-empty">ä¼¼ã¦ã„ã‚‹å†™çœŸã¯ã‚ã‚Šã¾ã›ã‚“</div></div>
    <!-- SCREENSHOTS -->
    <div class="page" id="p-ss"><div id="ss-grid" class="grid-3 grid"></div><div class="empty" id="ss-empty">ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div></div>
    <!-- VIDEOS -->
    <div class="page" id="p-vid"><div id="vid-grid" class="grid"></div><div class="empty" id="vid-empty">å¤§ããªå‹•ç”»ã¯ã‚ã‚Šã¾ã›ã‚“</div></div>
    <!-- BIG FILES -->
    <div class="page" id="p-big"><div id="big-grid" class="grid"></div><div class="empty" id="big-empty">å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</div></div>

    <div class="bot"><button class="bot-del" id="del-btn" onclick="confirmDel()">ğŸ—‘ <span id="del-txt">å‰Šé™¤</span></button></div>

    <div class="overlay" id="scan-ov">
        <div class="spinner"></div>
        <h3>ã‚¹ã‚­ãƒ£ãƒ³ä¸­...</h3>
        <div class="o-sub" id="o-sub">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†æã—ã¦ã„ã¾ã™</div>
        <div class="o-bar"><div class="o-fill" id="o-fill"></div></div>
        <div class="o-stats">
            <div class="o-stat"><b id="os-p">0</b><span>å†™çœŸ</span></div>
            <div class="o-stat"><b id="os-s">0</b><span>ã‚¹ã‚¯ã‚·ãƒ§</span></div>
            <div class="o-stat"><b id="os-v">0</b><span>å‹•ç”»</span></div>
            <div class="o-stat"><b id="os-b">0</b><span>å¤§å®¹é‡</span></div>
        </div>
    </div>

    <div class="modal" id="modal" onclick="if(event.target===this)closeModal()">
        <div class="modal-box">
            <h3 id="mod-t"></h3><p id="mod-d"></p>
            <button class="modal-btn danger" onclick="execDel()">å‰Šé™¤ã™ã‚‹</button>
            <button class="modal-btn cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <div class="toast" id="toast"><span id="toast-t"></span><button onclick="undo()">å…ƒã«æˆ»ã™</button></div>
</div>

<script>
// =========================================================
//  DATA
// =========================================================
const RAW_EXT = new Set(['cr2','nef','arw','dng','orf','rw2','pef','raf','srw','cr3','iiq','3fr','raw']);
const VID_EXT = new Set(['mp4','mov','avi','mkv','webm','m4v','3gp','wmv']);
const SS_PAT = ['screenshot','ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ','screen_shot','capture','ã‚¹ã‚¯ã‚·ãƒ§','ç”»é¢åéŒ²'];

let data = { similar:[], ss:[], vid:[], big:[] };
let tab = 'home';
let undoBuf = [], undoTab = '', toastTmr;

// =========================================================
//  CLASSIFY
// =========================================================
function ext(name){ return name.split('.').pop().toLowerCase(); }
function classify(file){
    const e = ext(file.name), t = file.type||'', n = file.name.toLowerCase(), mb = file.size/1048576;
    if(RAW_EXT.has(e)) return 'big';
    if(t.startsWith('video/') || VID_EXT.has(e)) return 'vid';
    if(t.startsWith('image/') || ['jpg','jpeg','png','webp','heic','gif','bmp'].includes(e)){
        if(SS_PAT.some(p=>n.includes(p))) return 'ss';
        if(e==='png' && mb < 3) return 'ss';
        if(mb > 8) return 'big';
        return 'photo';
    }
    return 'photo';
}
function fmtSz(b){
    if(b<1024) return b+'B';
    if(b<1048576) return (b/1024).toFixed(0)+'KB';
    if(b<1073741824) return (b/1048576).toFixed(1)+'MB';
    return (b/1073741824).toFixed(2)+'GB';
}

// =========================================================
//  FILE INPUT
// =========================================================
async function doFolder(){
    if('showDirectoryPicker' in window){
        try{
            const dh = await window.showDirectoryPicker({mode:'read'});
            showScan(); const files = []; await walk(dh,files); await process(files);
        }catch(e){ if(e.name!=='AbortError') fallbackFolder(); }
    } else fallbackFolder();
}
function fallbackFolder(){
    const i=document.getElementById('inp-folder');
    i.setAttribute('webkitdirectory',''); i.setAttribute('directory','');
    i.onchange=async function(){ if(this.files.length){showScan(); await process([...this.files]);} };
    i.click();
}
async function walk(dh,files,d=0){
    if(d>4)return;
    for await(const entry of dh.values()){
        if(entry.kind==='file'){try{const f=await entry.getFile();if(f.type.startsWith('image/')||f.type.startsWith('video/')||RAW_EXT.has(ext(f.name))||VID_EXT.has(ext(f.name)))files.push(f);}catch(e){}}
        else if(entry.kind==='directory') await walk(entry,files,d+1);
    }
}
function doFiles(){
    const i=document.getElementById('inp-files');
    i.removeAttribute('webkitdirectory'); i.removeAttribute('directory');
    i.onchange=async function(){ if(this.files.length){showScan(); await process([...this.files]);} };
    i.click();
}

// =========================================================
//  SCAN
// =========================================================
function showScan(){
    document.getElementById('scan-ov').classList.add('on');
    ['os-p','os-s','os-v','os-b'].forEach(id=>document.getElementById(id).textContent='0');
    document.getElementById('o-fill').style.width='0%';
}

async function process(files){
    const photos=[], ss=[], vid=[], big=[];
    let cp=0, cs=0, cv=0, cb=0;
    for(let i=0;i<files.length;i++){
        const f=files[i], cat=classify(f);
        const entry = { file:f, name:f.name, size:f.size, mb:+(f.size/1048576).toFixed(1), url:null };
        if(f.type.startsWith('image/')||f.type.startsWith('video/')) entry.url = URL.createObjectURL(f);

        if(cat==='ss'){ss.push(entry);cs++;}
        else if(cat==='vid'){vid.push(entry);cv++;}
        else if(cat==='big'){big.push(entry);cb++;}
        else{photos.push(entry);cp++;}

        const pct=((i+1)/files.length*100)|0;
        document.getElementById('o-fill').style.width=pct+'%';
        document.getElementById('o-sub').textContent=`${i+1} / ${files.length}`;
        document.getElementById('os-p').textContent=cp;
        document.getElementById('os-s').textContent=cs;
        document.getElementById('os-v').textContent=cv;
        document.getElementById('os-b').textContent=cb;
        if(i%15===0) await new Promise(r=>setTimeout(r,0));
    }

    // é¡ä¼¼å†™çœŸã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆç°¡æ˜“:ã‚µã‚¤ã‚ºè¿‘ã„ï¼‹åå‰é¡ä¼¼ã§ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ï¼‰
    const simGroups = buildSimilarGroups(photos);

    // å‹•ç”»ã¯ã‚µã‚¤ã‚ºå¤§ãã„é †
    vid.sort((a,b)=>b.size-a.size);
    big.sort((a,b)=>b.size-a.size);

    data = { similar:simGroups, ss, vid, big };

    document.getElementById('o-sub').textContent='å®Œäº†ï¼';
    await new Promise(r=>setTimeout(r,600));
    document.getElementById('scan-ov').classList.remove('on');

    renderAll();
    updateHome();
    document.getElementById('scan-ok').classList.add('on');
    document.getElementById('scan-ok-txt').textContent=`${files.length} ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æ¸ˆã¿ãƒ»åˆ†é¡å®Œäº†`;
}

function buildSimilarGroups(photos){
    if(photos.length < 2) return photos.map(p=>[p]);
    // ã‚µã‚¤ã‚ºã§ã‚½ãƒ¼ãƒˆã—ã¦è¿‘ã„ã‚‚ã®ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const sorted = [...photos].sort((a,b)=>a.size-b.size);
    const groups = [];
    let g = [sorted[0]];
    for(let i=1;i<sorted.length;i++){
        const diff = Math.abs(sorted[i].size - sorted[i-1].size);
        const ratio = diff / Math.max(sorted[i-1].size, 1);
        // ã‚µã‚¤ã‚ºãŒ20%ä»¥å†…ãªã‚‰åŒã‚°ãƒ«ãƒ¼ãƒ—
        if(ratio < 0.2 && g.length < 5){
            g.push(sorted[i]);
        } else {
            groups.push(g); g = [sorted[i]];
        }
    }
    groups.push(g);
    return groups;
}

// =========================================================
//  RENDER
// =========================================================
function renderAll(){
    renderSimilar();
    renderSS();
    renderVid();
    renderBig();
}

function renderSimilar(){
    const el = document.getElementById('sim-list');
    const emp = document.getElementById('sim-empty');
    if(!data.similar.length || data.similar.every(g=>g.length<2)){ el.innerHTML=''; emp.style.display='block'; return; }
    emp.style.display='none';
    el.innerHTML = data.similar.filter(g=>g.length>=2).map((g,gi)=>{
        const total = g.reduce((a,p)=>a+p.mb,0).toFixed(1);
        const items = g.map((p,pi)=>`
            <div class="item${pi>0?' on':''}" data-sz="${p.mb}" onclick="tog(this)">
                ${p.url?`<img src="${p.url}">`:`<div style="width:100%;aspect-ratio:1;background:var(--sf2);display:flex;align-items:center;justify-content:center;font-size:20px">ğŸ“·</div>`}
                <div class="sz">${p.mb}MB</div>
                <div class="ck">âœ“</div>
            </div>`).join('');
        return `<div class="grp" data-gi="${gi}">
            <div class="grp-head">
                <div class="grp-title">${g.length} æšãŒé¡ä¼¼ Â· ${total}MB</div>
                <div class="grp-btn" onclick="grpToggle(${gi})">ãƒ™ã‚¹ãƒˆä»¥å¤–ã‚’é¸æŠ</div>
            </div>
            <div class="grid">${items}</div>
        </div>`;
    }).join('');
}

function renderSS(){
    const el=document.getElementById('ss-grid'), emp=document.getElementById('ss-empty');
    if(!data.ss.length){el.innerHTML='';emp.style.display='block';return;}
    emp.style.display='none';
    el.innerHTML=data.ss.map((s,i)=>`
        <div class="item on" data-sz="${s.mb}" onclick="tog(this)" style="animation-delay:${i*.03}s">
            ${s.url?`<img src="${s.url}">`:`<div style="width:100%;aspect-ratio:1;background:var(--sf2);display:flex;align-items:center;justify-content:center;font-size:18px">ğŸ“±</div>`}
            <div class="sz">${s.mb}MB</div><div class="ck">âœ“</div>
        </div>`).join('');
}

function renderVid(){
    const el=document.getElementById('vid-grid'), emp=document.getElementById('vid-empty');
    if(!data.vid.length){el.innerHTML='';emp.style.display='block';return;}
    emp.style.display='none';
    el.innerHTML=data.vid.map((v,i)=>`
        <div class="item" data-sz="${v.mb}" onclick="tog(this)" style="animation-delay:${i*.03}s">
            ${v.url?`<img src="${v.url}">`:`<div style="width:100%;aspect-ratio:1;background:var(--sf2);display:flex;align-items:center;justify-content:center;font-size:22px">ğŸ¬</div>`}
            <div class="play">â–¶</div><div class="sz">${fmtSz(v.size)}</div><div class="ck">âœ“</div>
        </div>`).join('');
}

function renderBig(){
    const el=document.getElementById('big-grid'), emp=document.getElementById('big-empty');
    if(!data.big.length){el.innerHTML='';emp.style.display='block';return;}
    emp.style.display='none';
    el.innerHTML=data.big.map((b,i)=>`
        <div class="item" data-sz="${b.mb}" onclick="tog(this)" style="animation-delay:${i*.03}s">
            ${b.url?`<img src="${b.url}">`:`<div style="width:100%;aspect-ratio:1;background:var(--sf2);display:flex;align-items:center;justify-content:center;font-size:20px">ğŸ“</div>`}
            <div class="tag">${ext(b.name).toUpperCase()}</div><div class="sz">${fmtSz(b.size)}</div><div class="ck">âœ“</div>
        </div>`).join('');
}

function updateHome(){
    const simItems = document.querySelectorAll('#sim-list .item');
    const ssItems = document.querySelectorAll('#ss-grid .item');
    const vidItems = document.querySelectorAll('#vid-grid .item');
    const bigItems = document.querySelectorAll('#big-grid .item');

    const count = (els)=>{ let m=0; els.forEach(e=>m+=parseFloat(e.dataset.sz||0)); return m; };
    const fmt = (mb)=> mb<1000 ? mb.toFixed(0)+'MB' : (mb/1000).toFixed(1)+'GB';

    document.getElementById('c-sim').textContent = simItems.length ? `${simItems.length}æš Â· ${fmt(count(simItems))}` : 'â€”';
    document.getElementById('c-ss').textContent = ssItems.length ? `${ssItems.length}æš Â· ${fmt(count(ssItems))}` : 'â€”';
    document.getElementById('c-vid').textContent = vidItems.length ? `${vidItems.length}æœ¬ Â· ${fmt(count(vidItems))}` : 'â€”';
    document.getElementById('c-big').textContent = bigItems.length ? `${bigItems.length}å€‹ Â· ${fmt(count(bigItems))}` : 'â€”';

    const totalMB = count(simItems)+count(ssItems)+count(vidItems)+count(bigItems);
    document.getElementById('m-used').textContent = fmt(totalMB);
    const pct = Math.min(100, (totalMB / 50000 * 100)).toFixed(0);
    document.getElementById('m-pct').textContent = pct+'%';
    document.getElementById('m-fill').style.width = pct+'%';
}

// =========================================================
//  NAVIGATION
// =========================================================
function go(id){
    tab = id;
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));
    const back = document.getElementById('hd-back');
    const sel = document.getElementById('sel-btn');
    const title = document.getElementById('hd-title');
    const sub = document.getElementById('hd-sub');

    if(id==='home'){
        document.getElementById('p-home').classList.add('on');
        title.textContent='Smart Cleaner'; sub.style.display='none';
        back.style.display='none'; sel.style.display='none';
        document.getElementById('del-btn').classList.remove('show');
        updateHome();
    } else {
        const cfg = {
            similar:{p:'p-similar',t:'ä¼¼ã¦ã„ã‚‹å†™çœŸ'},
            ss:{p:'p-ss',t:'ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ'},
            vid:{p:'p-vid',t:'å¤§ããªå‹•ç”»'},
            big:{p:'p-big',t:'å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«'}
        };
        const c = cfg[id];
        document.getElementById(c.p).classList.add('on');
        title.textContent = c.t;
        back.style.display='block'; sel.style.display='block';
        sub.style.display='block';
        updateSub(); updateDelBtn();
    }
}

function updateSub(){
    const page = document.querySelector('.page.on');
    const items = page.querySelectorAll('.item');
    const checked = page.querySelectorAll('.item.on');
    let mb=0; checked.forEach(i=>mb+=parseFloat(i.dataset.sz||0));
    document.getElementById('hd-sub').textContent = `${checked.length} / ${items.length} é¸æŠä¸­ Â· ${mb<1000?mb.toFixed(1)+'MB':(mb/1000).toFixed(2)+'GB'}`;
    // Update select all btn
    const allOn = items.length>0 && items.length===checked.length;
    document.getElementById('sel-btn').textContent = allOn ? 'é¸æŠè§£é™¤' : 'ã™ã¹ã¦é¸æŠ';
}

// =========================================================
//  SELECTION
// =========================================================
function tog(el){ el.classList.toggle('on'); updateSub(); updateDelBtn(); }

function toggleAll(){
    const page = document.querySelector('.page.on');
    const items = page.querySelectorAll('.item');
    const allOn = items.length>0 && [...items].every(i=>i.classList.contains('on'));
    items.forEach(i=>i.classList.toggle('on',!allOn));
    updateSub(); updateDelBtn();
}

function grpToggle(gi){
    const grp = document.querySelector(`.grp[data-gi="${gi}"]`);
    const items = grp.querySelectorAll('.item');
    // First = best (off), rest = on
    items.forEach((item,i)=> item.classList.toggle('on', i > 0));
    updateSub(); updateDelBtn();
}

// =========================================================
//  DELETE
// =========================================================
function updateDelBtn(){
    const page = document.querySelector('.page.on');
    const checked = page.querySelectorAll('.item.on');
    const btn = document.getElementById('del-btn');
    const txt = document.getElementById('del-txt');
    if(checked.length){
        let mb=0; checked.forEach(i=>mb+=parseFloat(i.dataset.sz||0));
        const sz = mb<1000?mb.toFixed(1)+'MB':(mb/1000).toFixed(2)+'GB';
        txt.textContent=`${checked.length} ä»¶ã‚’å‰Šé™¤ Â· ${sz}`;
        btn.classList.add('show');
    } else btn.classList.remove('show');
}

function confirmDel(){
    const page = document.querySelector('.page.on');
    const cnt = page.querySelectorAll('.item.on').length;
    if(!cnt) return;
    let mb=0; page.querySelectorAll('.item.on').forEach(i=>mb+=parseFloat(i.dataset.sz||0));
    const sz=mb<1000?mb.toFixed(1)+'MB':(mb/1000).toFixed(2)+'GB';
    document.getElementById('mod-t').textContent=`${cnt} ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
    document.getElementById('mod-d').textContent=`${sz} ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒè§£æ”¾ã•ã‚Œã¾ã™`;
    document.getElementById('modal').classList.add('on');
}
function closeModal(){ document.getElementById('modal').classList.remove('on'); }

function execDel(){
    closeModal();
    const page = document.querySelector('.page.on');
    const sel = page.querySelectorAll('.item.on');
    undoBuf=[]; undoTab=tab;
    sel.forEach(i=>undoBuf.push({html:i.outerHTML,parent:i.parentElement,next:i.nextElementSibling}));
    const cnt=sel.length;
    sel.forEach((it,i)=>{it.style.transition='all .25s';it.style.transitionDelay=i*.02+'s';it.style.transform='scale(.4)';it.style.opacity='0';});
    setTimeout(()=>{
        sel.forEach(i=>i.remove());
        // Clean empty groups
        document.querySelectorAll('.grp').forEach(g=>{if(!g.querySelectorAll('.item').length){g.style.transition='all .25s';g.style.opacity='0';g.style.maxHeight='0';g.style.overflow='hidden';g.style.margin='0';g.style.padding='0';setTimeout(()=>g.remove(),250);}});
        updateDelBtn(); updateSub(); updateHome();
        // Show empty if needed
        const items = page.querySelectorAll('.item');
        if(!items.length){
            page.querySelectorAll('.empty').forEach(e=>e.style.display='block');
        }
    }, 250+sel.length*20);
    showToast(cnt);
}

// =========================================================
//  UNDO / TOAST
// =========================================================
function showToast(n){
    const t=document.getElementById('toast');
    document.getElementById('toast-t').innerHTML=`<strong>${n} ä»¶</strong> å‰Šé™¤ã—ã¾ã—ãŸ`;
    t.classList.add('show');
    clearTimeout(toastTmr);
    toastTmr=setTimeout(()=>{t.classList.remove('show');undoBuf=[];},5000);
}
function undo(){
    if(!undoBuf.length) return;
    undoBuf.reverse().forEach(d=>{
        const tmp=document.createElement('div');tmp.innerHTML=d.html;const el=tmp.firstElementChild;
        el.style.cssText='';
        if(d.next)d.parent.insertBefore(el,d.next);else d.parent.appendChild(el);
    });
    undoBuf=[];
    document.getElementById('toast').classList.remove('show');
    clearTimeout(toastTmr);
    updateDelBtn(); updateSub(); updateHome();
    document.querySelector('.page.on').querySelectorAll('.empty').forEach(e=>e.style.display='none');
}

// =========================================================
//  DEMO DATA (åˆæœŸè¡¨ç¤ºç”¨)
// =========================================================
function loadDemo(){
    const imgs = [
        'https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?w=250&q=75',
        'https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?w=250&q=75&blur=2',
        'https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?w=250&q=75&sepia=1',
        'https://images.unsplash.com/photo-1531306728370-53bfd6202e88?w=250&q=75',
        'https://images.unsplash.com/photo-1531306728370-53bfd6202e88?w=250&q=75&sepia=1',
        'https://images.unsplash.com/photo-1506157786151-b8491531f063?w=250&q=75',
        'https://images.unsplash.com/photo-1506157786151-b8491531f063?w=250&q=75&blur=2',
    ];
    const ss = [
        'https://images.unsplash.com/photo-1611162617474-5b21e879e113?w=200&q=70',
        'https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=200&q=70',
        'https://images.unsplash.com/photo-1531306728370-53bfd6202e88?w=200&q=70',
        'https://images.unsplash.com/photo-1511895426328-dc8714191300?w=200&q=70',
        'https://images.unsplash.com/photo-1504274066651-8d31a536b11a?w=200&q=70',
        'https://images.unsplash.com/photo-1588612143431-7e87ab06d71b?w=200&q=70',
    ];
    const vid = [
        {src:'https://images.unsplash.com/photo-1520697921389-9a2f647035ce?w=250&q=75',gb:6.86,dur:'07:54'},
        {src:'https://images.unsplash.com/photo-1506157786151-b8491531f063?w=250&q=75',gb:4.06,dur:'05:37'},
        {src:'https://images.unsplash.com/photo-1504274066651-8d31a536b11a?w=250&q=75',gb:3.52,dur:'04:44'},
        {src:'https://images.unsplash.com/photo-1511895426328-dc8714191300?w=250&q=75',gb:3.38,dur:'05:46'},
    ];
    const raw = [
        {src:'https://images.unsplash.com/photo-1621360841013-c76831f1a301?w=250&q=75',mb:45.2,ext:'CR2'},
        {src:'https://images.unsplash.com/photo-1600607688969-a5bfcd64fd28?w=250&q=75',mb:38.7,ext:'NEF'},
        {src:'https://images.unsplash.com/photo-1588612143431-7e87ab06d71b?w=250&q=75',mb:52.1,ext:'ARW'},
        {src:'https://images.unsplash.com/photo-1549608276-5786777e6587?w=250&q=75',mb:41.5,ext:'DNG'},
        {src:'https://images.unsplash.com/photo-1551373884-8a0750074df7?w=250&q=75',mb:48.9,ext:'CR2'},
        {src:'https://images.unsplash.com/photo-1534447677768-be436bb09401?w=250&q=75',mb:39.2,ext:'NEF'},
    ];

    // Similar
    const el=document.getElementById('sim-list');
    el.innerHTML = [
        {photos:imgs.slice(0,3),mbs:[2.6,2.6,2.4]},
        {photos:imgs.slice(3,5),mbs:[4.2,4.2]},
        {photos:imgs.slice(5,7),mbs:[3.8,3.6]}
    ].map((g,gi)=>{
        const total = g.mbs.reduce((a,b)=>a+b,0).toFixed(1);
        const items = g.photos.map((src,pi)=>`
            <div class="item${pi>0?' on':''}" data-sz="${g.mbs[pi]}" onclick="tog(this)">
                <img src="${src}" loading="lazy"><div class="sz">${g.mbs[pi]}MB</div><div class="ck">âœ“</div>
            </div>`).join('');
        return `<div class="grp" data-gi="${gi}">
            <div class="grp-head"><div class="grp-title">${g.photos.length} æšãŒé¡ä¼¼ Â· ${total}MB</div><div class="grp-btn" onclick="grpToggle(${gi})">ãƒ™ã‚¹ãƒˆä»¥å¤–ã‚’é¸æŠ</div></div>
            <div class="grid">${items}</div></div>`;
    }).join('');
    document.getElementById('sim-empty').style.display='none';

    // SS
    document.getElementById('ss-grid').innerHTML = ss.map((src,i)=>`
        <div class="item on" data-sz="1.8" onclick="tog(this)"><img src="${src}" loading="lazy"><div class="sz">1.8MB</div><div class="ck">âœ“</div></div>`).join('');
    document.getElementById('ss-empty').style.display='none';

    // Vid
    document.getElementById('vid-grid').innerHTML = vid.map(v=>`
        <div class="item" data-sz="${v.gb*1000}" onclick="tog(this)">
            <img src="${v.src}" loading="lazy"><div class="play">â–¶</div>
            <div class="sz">${v.gb}GB Â· ${v.dur}</div><div class="ck">âœ“</div>
        </div>`).join('');
    document.getElementById('vid-empty').style.display='none';

    // Big
    document.getElementById('big-grid').innerHTML = raw.map(r=>`
        <div class="item" data-sz="${r.mb}" onclick="tog(this)">
            <img src="${r.src}" loading="lazy"><div class="tag">${r.ext}</div><div class="sz">${r.mb}MB</div><div class="ck">âœ“</div>
        </div>`).join('');
    document.getElementById('big-empty').style.display='none';

    updateHome();
}

// =========================================================
//  INIT
// =========================================================
document.addEventListener('DOMContentLoaded',()=>{
    loadDemo();
    go('home');
    setTimeout(()=>document.getElementById('m-fill').style.width = '67%', 200);
});
</script>
</body>
</html>
