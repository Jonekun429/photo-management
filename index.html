<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cleaner Pro - Full Feature MVP</title>
    <style>
        :root {
            /* Cleaner Guruãƒ©ã‚¤ã‚¯ãªãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ»ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ */
            --bg: #0a0b10;
            --surface: #151828;
            --surface-hover: #1f2338;
            --text-main: #ffffff;
            --text-sub: #8a92b2;
            --accent-blue: #4a5ee9;
            --accent-cyan: #3ec4b5;
            --accent-danger: #e24b5a;
            --accent-warn: #f1c40f;
            --border: rgba(255, 255, 255, 0.08);
            --radius-l: 24px;
            --radius-m: 16px;
            --radius-s: 12px;
            --shadow: 0 8px 24px rgba(0,0,0,0.4);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
        }

        /* Reset & Base */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { background: #000; display: flex; justify-content: center; touch-action: manipulation; -webkit-font-smoothing: antialiased; color: var(--text-main); }
        #app { width: 100%; max-width: 414px; height: 100vh; height: 100dvh; background: var(--bg); position: relative; display: flex; flex-direction: column; overflow: hidden; }

        /* Typography */
        h1 { font-size: 28px; font-weight: 800; letter-spacing: 0.5px; }
        h2 { font-size: 20px; font-weight: 700; }
        p { font-size: 14px; color: var(--text-sub); }

        /* Header */
        header { padding: 50px 20px 10px; display: flex; justify-content: space-between; align-items: center; z-index: 20; background: var(--bg); flex-shrink: 0; }
        .h-actions { display: flex; gap: 12px; }
        .btn-pill { background: var(--surface); color: var(--text-sub); border: 1px solid var(--border); border-radius: 20px; padding: 6px 14px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .btn-pill .star { color: var(--accent-warn); font-size: 14px; }
        .btn-icon { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; color: var(--text-sub); font-size: 18px; }

        /* Mode Badge */
        .mode-badge { display: inline-block; background: var(--accent-warn); color: #000; font-size: 10px; font-weight: 800; padding: 3px 8px; border-radius: 6px; vertical-align: middle; margin-left: 8px; display: none; }
        .mode-badge.show { display: inline-block; animation: fadeIn 0.3s ease; }

        /* View Container */
        .view { flex: 1; overflow-y: auto; padding: 10px 20px 110px; display: none; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .view::-webkit-scrollbar { display: none; }
        .view.active { display: block; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px) } to { opacity: 1; transform: translateY(0) } }

        /* --- Access Panel (Upload & Sample Toggle) --- */
        .access-panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-m); padding: 16px; margin-bottom: 24px; text-align: center; }
        .access-panel p { font-size: 12px; margin-bottom: 12px; line-height: 1.4; }
        .btn-primary { width: 100%; padding: 14px; border-radius: 12px; border: none; background: linear-gradient(135deg, var(--accent-blue), #8a4aeb); color: #fff; font-size: 14px; font-weight: 700; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(74, 94, 233, 0.3); margin-bottom: 10px; }
        .btn-primary:active { transform: scale(0.97); }
        .btn-secondary { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border); background: var(--surface-hover); color: var(--text-main); font-size: 14px; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
        .btn-secondary:active { transform: scale(0.97); }
        .btn-danger-outline { color: var(--accent-danger); border-color: rgba(226, 75, 90, 0.3); background: rgba(226, 75, 90, 0.05); }

        /* --- Home View --- */
        .storage-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; }
        .storage-used { font-size: 13px; color: var(--text-sub); font-weight: 600; }
        .storage-used strong { color: var(--accent-blue); font-size: 15px; }
        .storage-pct { font-size: 12px; color: var(--text-main); font-weight: 500; }
        .progress-bar { width: 100%; height: 6px; background: var(--surface); border-radius: 4px; margin-bottom: 24px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent-blue), #8a4aeb); border-radius: 4px; transition: width 0.5s ease; }

        .home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card { border-radius: var(--radius-l); position: relative; overflow: hidden; cursor: pointer; background-size: cover; background-position: center; box-shadow: var(--shadow); transition: transform 0.2s; }
        .card:active { transform: scale(0.97); }
        .card::after { content: ''; position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.1) 60%, rgba(0,0,0,0) 100%); z-index: 1; pointer-events: none; }
        .card-content { position: absolute; bottom: 18px; left: 16px; right: 16px; z-index: 2; }
        .card h3 { font-size: 14px; font-weight: 600; margin-bottom: 2px; text-shadow: 0 2px 4px rgba(0,0,0,0.6); color: rgba(255,255,255,0.9); }
        .card .size { font-size: 24px; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.6); letter-spacing: -0.5px; }

        .c-sim { height: 240px; background-image: url('https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?w=400&q=80'); grid-row: span 2; }
        .c-vid { height: 260px; background-image: url('https://images.unsplash.com/photo-1600607688969-a5bfcd64fd28?w=400&q=80'); }
        .c-sim-vid { height: 180px; background-image: url('https://images.unsplash.com/photo-1506157786151-b8491531f063?w=400&q=80'); }
        .c-ss { height: 160px; background-color: #ffffff; background-image: url('https://images.unsplash.com/photo-1611162617474-5b21e879e113?w=400&q=80'); background-blend-mode: overlay; }
        .c-ss::after { background: linear-gradient(to top, rgba(255,255,255,1) 0%, rgba(255,255,255,0.4) 60%, rgba(255,255,255,0) 100%); }
        .c-ss h3 { color: #555; text-shadow: none; }
        .c-ss .size { color: #000; text-shadow: none; }

        /* --- Swipe View --- */
        .stats-header { display: flex; gap: 12px; margin-bottom: 24px; }
        .stat-box { flex: 1; background: var(--surface); border-radius: var(--radius-m); padding: 16px; display: flex; align-items: center; gap: 14px; border: 1px solid var(--border); }
        .stat-icon { font-size: 28px; }
        .stat-label { font-size: 11px; color: var(--text-sub); margin-bottom: 2px; font-weight: 600; }
        .stat-val { font-size: 17px; font-weight: 800; }

        .month-list { display: flex; flex-direction: column; gap: 14px; }
        .m-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-m); padding: 16px; display: flex; gap: 16px; align-items: center; cursor: pointer; transition: transform 0.2s; }
        .m-card:active { transform: scale(0.98); background: var(--surface-hover); }
        .m-thumb { width: 68px; height: 68px; border-radius: 12px; background-size: cover; background-position: center; position: relative; flex-shrink: 0; background-color: var(--surface-hover); }
        .m-thumb.done::after { content: 'âœ“'; position: absolute; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: bold; border-radius: inherit; }
        .m-info { flex: 1; }
        .m-title { font-size: 17px; font-weight: 700; margin-bottom: 8px; display: flex; justify-content: space-between; }
        .m-medal { font-size: 24px; opacity: 0.2; }
        .m-medal.active { opacity: 1; }
        .m-prog-txt { font-size: 12px; color: var(--text-sub); margin-bottom: 6px; font-weight: 500; }
        .m-prog-bg { width: 100%; height: 4px; background: rgba(255,255,255,0.05); border-radius: 2px; overflow: hidden; }
        .m-prog-fill { height: 100%; background: var(--accent-cyan); border-radius: 2px; transition: width 0.3s; }

        /* --- Swipe Play Screen --- */
        #swipe-play { position: absolute; inset: 0; background: var(--bg); z-index: 100; display: none; flex-direction: column; padding: 50px 20px 30px; }
        .sp-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .sp-back { font-size: 16px; font-weight: 600; color: var(--text-sub); cursor: pointer; padding: 10px 0; }
        .sp-prog-txt { font-size: 11px; color: var(--text-sub); text-align: right; margin-bottom: 6px; }
        .sp-img-container { flex: 1; border-radius: var(--radius-l); background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; box-shadow: var(--shadow); margin-bottom: 20px; }
        .sp-img { max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease; border-radius: inherit; }
        .swipe-left { transform: translateX(-120%) rotate(-15deg); opacity: 0; }
        .swipe-right { transform: translateX(120%) rotate(15deg); opacity: 0; }
        
        .sp-actions { display: flex; gap: 16px; justify-content: center; }
        .sp-btn { flex: 1; height: 60px; border-radius: var(--radius-m); border: none; font-size: 16px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: transform 0.1s; }
        .sp-btn:active { transform: scale(0.95); }
        .btn-dislike { background: var(--surface); border: 2px solid var(--accent-danger); color: var(--accent-danger); }
        .btn-like { background: var(--accent-cyan); color: #000; border: 2px solid var(--accent-cyan); }

        /* --- Results View --- */
        .res-container { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 20px 0; }
        .res-icon { width: 80px; height: 80px; background: linear-gradient(135deg, var(--accent-blue), #8a4aeb); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(74, 94, 233, 0.4); }
        .res-container h2 { font-size: 24px; margin-bottom: 8px; }
        .res-container p { font-size: 14px; margin-bottom: 30px; }
        .res-stats { width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 35px; }
        .rs-box { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-m); padding: 20px 10px; display: flex; flex-direction: column; align-items: center; }
        .rs-box.danger { border-color: rgba(226, 75, 90, 0.3); background: linear-gradient(to bottom, var(--surface), rgba(226, 75, 90, 0.05)); }
        .rs-box span { font-size: 12px; color: var(--text-sub); margin-bottom: 8px; font-weight: 600; }
        .rs-box strong { font-size: 26px; font-weight: 800; }
        .rs-box.danger strong { color: var(--accent-danger); }

        /* --- Tools View --- */
        .tool-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 30px; }
        .tool-item { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-m); padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .tool-item:active { background: var(--surface-hover); }
        .tool-left { display: flex; align-items: center; gap: 16px; }
        .tool-ic { font-size: 22px; }
        .tool-name { font-size: 15px; font-weight: 600; }
        .tool-sub { font-size: 11px; color: var(--text-sub); margin-top: 2px; }
        .tool-arr { color: var(--text-sub); font-size: 18px; font-weight: bold; }

        /* --- Loading Overlay --- */
        .loading-overlay { position: absolute; inset: 0; background: rgba(10, 11, 16, 0.95); z-index: 200; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .loading-overlay.show { display: flex; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Bottom Navigation --- */
        nav { position: absolute; bottom: 0; left: 0; width: 100%; height: 85px; background: rgba(10, 11, 16, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: flex; justify-content: space-around; align-items: center; padding-bottom: 20px; border-top: 1px solid var(--border); z-index: 40; }
        .ni { display: flex; flex-direction: column; align-items: center; color: var(--text-sub); font-size: 10px; font-weight: 600; cursor: pointer; transition: color 0.2s; width: 60px; }
        .ni.on { color: var(--accent-cyan); }
        .nic { font-size: 24px; margin-bottom: 4px; }
        
        .empty { display: none; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; text-align: center; }
        .empty-icon { font-size: 40px; margin-bottom: 16px; opacity: 0.5; }
    </style>
</head>
<body>
<div id="app">
    <header>
        <div>
            <h1 style="display:inline-block;" id="title">ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸</h1>
            <span id="mode-badge" class="mode-badge">SAMPLE</span>
        </div>
        <div class="h-actions">
            <button class="btn-pill"><span class="star">â˜…</span> ä»–ã®ã‚¢ãƒ—ãƒª</button>
            <button class="btn-icon">âš™</button>
        </div>
    </header>

    <main id="home" class="view active">
        
        <div class="access-panel">
            <p>å®Ÿéš›ã®å†™çœŸã‚’è¿½åŠ ã™ã‚‹ã‹ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã§<br>ã‚¢ãƒ—ãƒªã®å‹•ãã‚’ä½“é¨“ã§ãã¾ã™ã€‚</p>
            <button class="btn-primary" onclick="document.getElementById('fi-files').click()">
                ğŸ“¸ è‡ªåˆ†ã®å†™çœŸã‚’è¿½åŠ ã™ã‚‹
            </button>
            <button class="btn-secondary" id="demo-toggle-btn" onclick="toggleSampleMode()">
                ğŸª„ ã‚µãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§ä½“é¨“
            </button>
            <input type="file" id="fi-files" style="display:none;" accept="image/*,video/*" multiple onchange="handleFiles(this)">
        </div>

        <div class="storage-header">
            <div class="storage-used"><strong id="home-used-sz">0 MB</strong> ã‚’ä½¿ç”¨ä¸­ : å…¨ 2,000 GB</div>
            <div class="storage-pct" id="home-pct-txt">0% ä½¿ç”¨æ¸ˆã¿</div>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="home-prog-bar"></div></div>

        <div class="home-grid">
            <div style="display:flex; flex-direction:column; gap:12px;">
                <div class="card c-sim" onclick="navTo('swipe')">
                    <div class="card-content">
                        <h3>ä¼¼ã¦ã„ã‚‹å†™çœŸ</h3><div class="size" id="card-sz-sim">0 MB</div>
                    </div>
                </div>
                <div class="card c-sim-vid">
                    <div class="card-content">
                        <h3>é¡ä¼¼ã®ãƒ“ãƒ‡ã‚ª</h3><div class="size" id="card-sz-vid">0 MB</div>
                    </div>
                </div>
            </div>
            <div style="display:flex; flex-direction:column; gap:12px;">
                <div class="card c-vid">
                    <div class="card-content">
                        <h3>å‹•ç”»ã‚’æ•´ç†</h3><div class="size" id="card-sz-org">0 MB</div>
                    </div>
                </div>
                <div class="card c-ss">
                    <div class="card-content">
                        <h3>ã‚¹ã‚¯ã‚·ãƒ§</h3><div class="size" id="card-sz-ss">0 MB</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <main id="swipe" class="view">
        <div class="stats-header">
            <div class="stat-box">
                <div class="stat-icon">ğŸ–ï¸</div>
                <div>
                    <div class="stat-label">å ±é…¬:</div>
                    <div class="stat-val" id="reward-cnt">0/0</div>
                </div>
            </div>
            <div class="stat-box">
                <div class="stat-icon">ğŸ§¹</div>
                <div>
                    <div class="stat-label">ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿:</div>
                    <div class="stat-val" id="cleaned-sz">0 MB</div>
                </div>
            </div>
        </div>

        <div class="month-list" id="month-list-container">
            <div class="empty" style="display:flex;"><div class="empty-icon">ğŸ“</div><p>ãƒ›ãƒ¼ãƒ ã‹ã‚‰å†™çœŸã‚’è¿½åŠ ã™ã‚‹ã¨<br>ã“ã“ã«æ•´ç†ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p></div>
        </div>
    </main>

    <div id="swipe-play">
        <div class="sp-top">
            <div class="sp-back" onclick="closeSwipePlay()">â€¹ æˆ»ã‚‹</div>
            <h2 style="font-size:16px;" id="sp-month-title">å¹´æœˆ</h2>
            <div style="width:40px;"></div>
        </div>
        
        <div class="m-prog-bg" style="margin-bottom:8px;"><div class="m-prog-fill" id="sp-prog-bar" style="width: 0%;"></div></div>
        <div class="sp-prog-txt"><span id="sp-txt">0/0</span> ä»¶ã‚’ç¢ºèªæ¸ˆã¿</div>

        <div class="sp-img-container">
            <img id="sp-img" class="sp-img" src="">
        </div>

        <div class="sp-actions">
            <button class="sp-btn btn-dislike" onclick="handleSwipe('del')">ğŸ‘ å‰Šé™¤</button>
            <button class="sp-btn btn-like" onclick="handleSwipe('keep')">ğŸ‘ ä¿æŒ</button>
        </div>
    </div>

    <main id="results" class="view">
        <div class="res-container">
            <div class="res-icon">âœ¨</div>
            <h2>ã‚¹ãƒ¯ã‚¤ãƒ—å®Œäº†ï¼</h2>
            <p id="res-month-title">æ•´ç†ãŒçµ‚ã‚ã‚Šã¾ã—ãŸ</p>
            
            <div class="res-stats">
                <div class="rs-box">
                    <span>æ®‹ã™å†™çœŸ</span>
                    <strong id="res-keep-cnt">0</strong>
                </div>
                <div class="rs-box danger">
                    <span>å‰Šé™¤ã™ã‚‹å†™çœŸ</span>
                    <strong id="res-del-cnt">0</strong>
                    <small id="res-del-sz">0 MB è§£æ”¾</small>
                </div>
            </div>
            
            <button class="btn-primary" style="background:var(--accent-danger); box-shadow:0 4px 15px rgba(226,75,90,0.3)" onclick="executeNativeDeleteMock()">ğŸ—‘ iPhoneã‹ã‚‰å‰Šé™¤ã™ã‚‹</button>
            <button class="btn-secondary" style="margin-top:12px; border:none; background:transparent;" onclick="closeSwipePlay()">ã‚ã¨ã§å‰Šé™¤ã™ã‚‹</button>
        </div>
    </main>

    <main id="tools" class="view">
        <h2 style="margin-bottom: 16px; font-size: 14px; color: var(--text-sub);">ãƒ„ãƒ¼ãƒ«</h2>
        <div class="tool-list">
            <div class="tool-item"><div class="tool-left"><span class="tool-ic">ğŸ“Š</span><span class="tool-name">ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ</span></div><div class="tool-arr">â€º</div></div>
            <div class="tool-item"><div class="tool-left"><span class="tool-ic">âš¡</span><span class="tool-name">å……é›»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</span></div><div class="tool-arr">â€º</div></div>
            <div class="tool-item"><div class="tool-left"><span class="tool-ic">ğŸ”’</span><span class="tool-name">ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ•ã‚©ãƒ«ãƒ€ãƒ¼</span></div><div class="tool-arr">â€º</div></div>
        </div>

        <h2 style="margin-bottom: 16px; font-size: 14px; color: var(--text-sub); margin-top:20px;">ä»–ã®ã‚¢ãƒ—ãƒªã®æ©Ÿèƒ½</h2>
        <div class="tool-list">
            <div class="tool-item">
                <div class="tool-left"><span class="tool-ic">âœ¨</span><div><div class="tool-name">å†™çœŸã‚’å¼·åŒ–</div><div class="tool-sub">Visifyã‚’ä½¿ç”¨</div></div></div>
                <div class="tool-arr">â€º</div>
            </div>
            <div class="tool-item">
                <div class="tool-left"><span class="tool-ic">ğŸ“„</span><div><div class="tool-name">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚¹ã‚­ãƒ£ãƒ³</div><div class="tool-sub">ScanGuruã‚’ä½¿ç”¨</div></div></div>
                <div class="tool-arr">â€º</div>
            </div>
        </div>
    </main>

    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <h3 style="font-size:18px;">èª­ã¿è¾¼ã¿ä¸­...</h3>
        <p id="loading-txt" style="color:var(--text-sub); font-size:13px; margin-top:8px;">0 / 0 æš</p>
    </div>

    <nav>
        <div class="ni on" data-t="home" onclick="navTo('home')"><div class="nic">ğŸ </div><span>ãƒ›ãƒ¼ãƒ </span></div>
        <div class="ni" data-t="swipe" onclick="navTo('swipe')"><div class="nic">ğŸƒ</div><span>ã‚¹ãƒ¯ã‚¤ãƒ—</span></div>
        <div class="ni" data-t="tools" onclick="navTo('tools')"><div class="nic">âš™ï¸</div><span>è¿½åŠ </span></div>
    </nav>
</div>

<script>
// --- State Management ---
let isSampleMode = false;
let realState = { globalFiles: [], swipeMonthsData: {}, totalInitialMB: 0, cleanedTotalMB: 0 };
let globalFiles = []; 
let swipeMonthsData = {}; 
let totalInitialMB = 0;
let cleanedTotalMB = 0;
let swipeActiveMonthKey = null;

const DEMO_URLS = [
    'https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?w=600&q=80',
    'https://images.unsplash.com/photo-1531306728370-53bfd6202e88?w=600&q=80',
    'https://images.unsplash.com/photo-1506157786151-b8491531f063?w=600&q=80',
    'https://images.unsplash.com/photo-1621360841013-c76831f1a301?w=600&q=80',
    'https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=600&q=80'
];

// --- Navigation Logic ---
function navTo(id) {
    document.querySelectorAll('.ni').forEach(x => x.classList.remove('on'));
    const tab = document.querySelector(`.ni[data-t="${id}"]`);
    if(tab) tab.classList.add('on');
    
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    
    const titles = { home: 'ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸', swipe: 'å†™çœŸã‚’ã‚¹ãƒ¯ã‚¤ãƒ—', tools: 'è¿½åŠ ãƒ„ãƒ¼ãƒ«', results: 'æ•´ç†çµæœ' };
    document.getElementById('title').innerText = titles[id] || id;

    if (id === 'swipe') {
        document.getElementById('swipe-list-view').style.display = 'block';
        document.getElementById('swipe-play').style.display = 'none';
    }
}

// --- Sample Mode Logic ---
function toggleSampleMode() {
    const btn = document.getElementById('demo-toggle-btn');
    const badge = document.getElementById('mode-badge');

    if (!isSampleMode) {
        isSampleMode = true;
        realState.globalFiles = [...globalFiles];
        realState.swipeMonthsData = Object.assign({}, swipeMonthsData);
        realState.totalInitialMB = totalInitialMB;
        realState.cleanedTotalMB = cleanedTotalMB;

        btn.innerHTML = 'âŒ ã‚µãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†';
        btn.classList.add('btn-danger-outline');
        badge.classList.add('show');

        loadSampleData();
    } else {
        isSampleMode = false;
        globalFiles = [...realState.globalFiles];
        swipeMonthsData = Object.assign({}, realState.swipeMonthsData);
        totalInitialMB = realState.totalInitialMB;
        cleanedTotalMB = realState.cleanedTotalMB;

        btn.innerHTML = 'ğŸª„ ã‚µãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§ä½“é¨“';
        btn.classList.remove('btn-danger-outline');
        badge.classList.remove('show');

        refreshAllViews();
        navTo('home');
    }
}

function loadSampleData() {
    globalFiles = []; swipeMonthsData = {}; totalInitialMB = 0; cleanedTotalMB = 0;
    createDemoMonth('2026-02', '2026å¹´2æœˆ', 6);
    createDemoMonth('2026-01', '2026å¹´1æœˆ', 4);
    refreshAllViews();
}

function createDemoMonth(mKey, title, count) {
    if(!swipeMonthsData[mKey]) swipeMonthsData[mKey] = { id: mKey, title: title, total: 0, done: 0, photos: [], kept: [], deleted: [], savedMB: 0, isCleaned: false };
    for(let i=0; i<count; i++) {
        let sz = Math.round((Math.random() * 3 + 1)*10)/10;
        totalInitialMB += sz;
        let url = DEMO_URLS[i % DEMO_URLS.length];
        let photoObj = { id: 'demo_'+Math.random(), url: url, szMB: sz, monthKey: mKey };
        globalFiles.push(photoObj);
        swipeMonthsData[mKey].total++;
        swipeMonthsData[mKey].photos.push(photoObj);
    }
}

function refreshAllViews() {
    updateHomeStats();
    renderSwipeList();
}

// --- Async File Upload ---
async function handleFiles(inputElement) {
    const filesList = inputElement.files;
    if(!filesList.length) return;
    if (isSampleMode) toggleSampleMode();

    const loader = document.getElementById('loading-overlay');
    const loaderTxt = document.getElementById('loading-txt');
    loader.classList.add('show');
    
    const total = filesList.length;
    let processed = 0;
    const chunkSize = 5; 
    const filesArray = Array.from(filesList);

    for (let i = 0; i < total; i += chunkSize) {
        const chunk = filesArray.slice(i, i + chunkSize);
        await new Promise(resolve => setTimeout(() => {
            for(let f of chunk) {
                if(f.type && !f.type.startsWith('image/') && !f.type.startsWith('video/')) continue;
                let d = f.lastModified ? new Date(f.lastModified) : new Date();
                let mKey = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                let sz = parseFloat((f.size / 1024 / 1024).toFixed(2));
                totalInitialMB += sz;
                
                let photoObj = { id: Math.random().toString(36).substr(2,9), url: URL.createObjectURL(f), szMB: sz, monthKey: mKey };
                globalFiles.push(photoObj);

                if(!swipeMonthsData[mKey]) {
                    swipeMonthsData[mKey] = { id: mKey, title: `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ`, total: 0, done: 0, photos: [], kept: [], deleted: [], savedMB: 0, isCleaned: false };
                }
                swipeMonthsData[mKey].total++;
                swipeMonthsData[mKey].photos.push(photoObj);
            }
            processed += chunk.length;
            loaderTxt.innerText = `${Math.min(processed, total)} / ${total} æšã‚’èª­è¾¼ä¸­...`;
            resolve();
        }, 10)); 
    }

    inputElement.value = ''; 
    refreshAllViews();
    loader.classList.remove('show');
    navTo('swipe'); 
}

// --- Update UI ---
function updateHomeStats() {
    let currentTotalMB = globalFiles.reduce((sum, p) => sum + p.szMB, 0);
    let displayMB = currentTotalMB < 1000 ? `${currentTotalMB.toFixed(1)} MB` : `${(currentTotalMB/1000).toFixed(2)} GB`;
    
    document.getElementById('home-used-sz').innerText = displayMB;
    let pct = totalInitialMB > 0 ? (currentTotalMB / totalInitialMB) * 100 : 0;
    document.getElementById('home-prog-bar').style.width = pct + '%';
    document.getElementById('home-pct-txt').innerText = globalFiles.length > 0 ? 'è§£æå®Œäº†' : '0% ä½¿ç”¨æ¸ˆã¿';

    // Masonry Grid Dummy Distribution
    document.getElementById('card-sz-sim').innerText = currentTotalMB > 0 ? `${(currentTotalMB * 0.4).toFixed(1)} MB` : '0 MB';
    document.getElementById('card-sz-vid').innerText = currentTotalMB > 0 ? `${(currentTotalMB * 0.3).toFixed(1)} MB` : '0 MB';
    document.getElementById('card-sz-org').innerText = currentTotalMB > 0 ? `${(currentTotalMB * 0.2).toFixed(1)} MB` : '0 MB';
    document.getElementById('card-sz-ss').innerText = currentTotalMB > 0 ? `${(currentTotalMB * 0.1).toFixed(1)} MB` : '0 MB';
}

function renderSwipeList() {
    const cont = document.getElementById('month-list-container');
    const monthsArr = Object.values(swipeMonthsData).sort((a,b) => b.id.localeCompare(a.id));
    if(monthsArr.length === 0) {
        cont.innerHTML = `<div class="empty" style="display:flex;"><div class="empty-icon">ğŸ“</div><p>ãƒ›ãƒ¼ãƒ ã‹ã‚‰å†™çœŸã‚’è¿½åŠ ã™ã‚‹ã¨<br>ã“ã“ã«æ•´ç†ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p></div>`;
        document.getElementById('reward-cnt').innerText = `0/0`;
        document.getElementById('cleaned-sz').innerText = `0 MB`;
        return;
    }
    
    let compCount = 0;
    cont.innerHTML = monthsArr.map(m => {
        const pct = (m.done / m.total) * 100;
        const isComp = m.done === m.total;
        if(m.isCleaned) compCount++;
        const thumbUrl = m.photos.length > 0 ? m.photos[0].url : '';
        return `
            <div class="m-card" onclick="startSwipe('${m.id}')">
                <div class="m-thumb ${m.isCleaned ? 'done' : ''}" style="background-image:url('${thumbUrl}')"></div>
                <div class="m-info">
                    <div class="m-title"><span>${m.title}</span><span class="m-medal ${m.isCleaned?'active':''}">ğŸ…</span></div>
                    <div class="m-prog-txt">${m.done}/${m.total} ä»¶ã‚’ç¢ºèªæ¸ˆã¿</div>
                    <div class="m-prog-bg"><div class="m-prog-fill" style="width: ${pct}%"></div></div>
                </div>
            </div>
        `;
    }).join('');
    
    let displayCleaned = cleanedTotalMB < 1000 ? `${cleanedTotalMB.toFixed(1)} MB` : `${(cleanedTotalMB/1000).toFixed(2)} GB`;
    document.getElementById('reward-cnt').innerText = `${compCount}/${monthsArr.length}`;
    document.getElementById('cleaned-sz').innerText = displayCleaned;
}

// --- Swipe Engine ---
function startSwipe(monthKey) {
    const month = swipeMonthsData[monthKey];
    if (month.isCleaned) { alert("ã“ã®æœˆã¯ã™ã§ã«å‰Šé™¤å®Œäº†ã—ã¦ã„ã¾ã™ã€‚"); return; }
    if (month.done >= month.total) { showResults(monthKey); return; }
    
    swipeActiveMonthKey = monthKey;
    document.getElementById('sp-month-title').innerText = month.title;
    
    document.getElementById('swipe-list-view').style.display = 'none';
    const playView = document.getElementById('swipe-play');
    playView.style.display = 'flex';
    setTimeout(() => { playView.style.opacity = '1'; }, 10);
    
    updateSwipeCard();
}

function updateSwipeCard() {
    const month = swipeMonthsData[swipeActiveMonthKey];
    document.getElementById('sp-txt').innerText = `${month.done}/${month.total}`;
    document.getElementById('sp-prog-bar').style.width = ((month.done / month.total) * 100) + '%';
    
    if (month.done >= month.total) { setTimeout(() => showResults(swipeActiveMonthKey), 400); return; }
    
    const currentImg = month.photos[month.done];
    const imgEl = document.getElementById('sp-img');
    imgEl.className = 'sp-img'; 
    setTimeout(() => { imgEl.src = currentImg.url; }, 50);
}

function handleSwipe(action) {
    const imgEl = document.getElementById('sp-img');
    const month = swipeMonthsData[swipeActiveMonthKey];
    const currentImg = month.photos[month.done];
    
    if (action === 'del') {
        imgEl.classList.add('swipe-left');
        month.deleted.push(currentImg);
        month.savedMB += currentImg.szMB;
    } else {
        imgEl.classList.add('swipe-right');
        month.kept.push(currentImg);
    }
    month.done += 1;
    setTimeout(() => updateSwipeCard(), 300);
}

function closeSwipePlay() {
    document.getElementById('swipe-play').style.display = 'none';
    navTo('swipe');
    renderSwipeList();
}

// --- Results & Mock Delete ---
function showResults(monthKey) {
    const month = swipeMonthsData[monthKey];
    document.getElementById('res-month-title').innerText = `${month.title} ã®æ•´ç†ãŒçµ‚ã‚ã‚Šã¾ã—ãŸ`;
    document.getElementById('res-keep-cnt').innerText = `${month.kept.length} æš`;
    document.getElementById('res-del-cnt').innerText = `${month.deleted.length} æš`;
    document.getElementById('res-del-sz').innerText = `${month.savedMB.toFixed(1)} MB è§£æ”¾å¯èƒ½`;
    
    document.getElementById('swipe-play').style.display = 'none';
    navTo('results');
}

function executeNativeDeleteMock() {
    const month = swipeMonthsData[swipeActiveMonthKey];
    if(month.deleted.length === 0) {
        alert("å‰Šé™¤ã™ã‚‹å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“ï¼ç´ æ™´ã‚‰ã—ã„æ•´ç†æ•´é “ã§ã™ã€‚");
        month.isCleaned = true; closeSwipePlay(); return;
    }

    if(confirm(`"${month.title}" ã®å†™çœŸ ${month.deleted.length}æš ã‚’iPhoneã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n(iOSé€£æºã®ãƒ‡ãƒ¢)`)) {
        const deletedIds = month.deleted.map(p => p.id);
        globalFiles = globalFiles.filter(p => !deletedIds.includes(p.id));
        cleanedTotalMB += month.savedMB;
        month.isCleaned = true;
        
        refreshAllViews();
        alert(`âœ¨ å‰Šé™¤å®Œäº†ï¼\nå®¹é‡ãŒ ${month.savedMB.toFixed(1)} MB å¢—ãˆã¾ã—ãŸã€‚`);
        closeSwipePlay();
    }
}

// Prevent bouncy scrolling on iOS
document.body.addEventListener('touchmove', function(e) {
    if(!e.target.closest('.view') && !e.target.closest('#swipe-play')) e.preventDefault();
}, { passive: false });

// Init
document.addEventListener('DOMContentLoaded', () => {
    refreshAllViews();
});
</script>
</body>
</html>
