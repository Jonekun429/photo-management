<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cleaner Pro - Async Loading Update</title>
    <style>
        :root {
            --bg:#04100e;--card:#0c1f1b;--card2:#153029;--text:#eaf5f2;--sub:#5a7d75;--dim:#3d5c54;
            --pri:#005D4D;--pri2:#00896e;--bright:#00b894;--grad:linear-gradient(135deg,#005D4D,#00896e);
            --glow:rgba(0,93,77,.25);--danger:#ff4757;--dgrad:linear-gradient(135deg,#ff4757,#ff6b7a);
            --amber:#ffb142;--badge:rgba(4,16,14,.82);--bdr:rgba(0,93,77,.12);--bdr2:rgba(0,93,77,.3);
            --sh:0 8px 32px rgba(0,0,0,.4);--rl:20px;--rm:14px;--rs:10px;
        }
        *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
        body{font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Helvetica Neue",sans-serif;background:#000;display:flex;justify-content:center;touch-action:manipulation;-webkit-font-smoothing:antialiased}
        #app{width:100%;max-width:414px;height:100vh;height:100dvh;background:var(--bg);color:var(--text);position:relative;display:flex;flex-direction:column;overflow:hidden}

        header{padding:52px 20px 10px;display:flex;flex-direction:column;gap:10px;z-index:20;background:var(--bg);flex-shrink:0}
        .h-top{display:flex;justify-content:space-between;align-items:center;height:36px}
        .back{font-size:24px;cursor:pointer;display:none;padding:4px 14px 4px 0;color:var(--bright);transition:opacity .2s;font-weight:300}
        .back:active{opacity:.4}
        .h-act{display:none;gap:8px;align-items:center}
        .h-tr{display:flex;justify-content:space-between;align-items:flex-end}
        h1{font-size:28px;font-weight:700;letter-spacing:-.5px}
        .h-sub{font-size:12.5px;color:var(--sub);margin-top:2px;display:none}
        .gear{background:var(--card);border:1px solid var(--bdr);border-radius:50%;width:38px;height:38px;display:flex;justify-content:center;align-items:center;font-size:17px;cursor:pointer}

        .view{flex:1;overflow-y:auto;padding:0 20px 110px;display:none;-webkit-overflow-scrolling:touch;scrollbar-width:none}
        .view::-webkit-scrollbar{display:none}
        .view.active{display:block;animation:fi .3s ease}
        @keyframes fi{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

        /* ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ãƒãƒ« */
        .access{background:var(--card);border:1px solid var(--bdr2);border-radius:var(--rl);padding:20px;margin-top:15px;overflow:hidden}
        .access-head{text-align:center;margin-bottom:15px}
        .access-head h4{font-size:15px;font-weight:700;margin-bottom:4px}
        .access-head p{font-size:12px;color:var(--sub);line-height:1.5}
        .a-btn{width:100%;padding:14px;border:none;border-radius:12px;font-size:14.5px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s;background:var(--grad);color:#fff;box-shadow:0 4px 16px rgba(0,93,77,.3)}
        .a-btn:active{transform:scale(.97)}
        .a-btn.danger{background:var(--dgrad);box-shadow:0 4px 16px rgba(255,71,87,.3)}
        .a-btn.secondary{background:var(--card2);color:var(--bright);border:1px solid var(--bdr2);box-shadow:none}
        .file-in{display:none}

        /* ã‚µãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ãƒãƒƒã‚¸ */
        .mode-badge { display:inline-block; background:var(--amber); color:#000; font-size:10px; font-weight:800; padding:3px 8px; border-radius:6px; vertical-align:middle; margin-left:8px; display:none; }
        .mode-badge.show { display:inline-block; animation:fi 0.3s ease; }

        /* Home */
        .sto-row{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:10px}
        .sto-u{font-size:12.5px;color:var(--sub)}.sto-u strong{color:var(--bright);font-weight:600}
        .sto-p{font-size:11px;font-weight:700;color:var(--amber);background:rgba(255,177,66,.1);padding:3px 8px;border-radius:6px}
        .prog{width:100%;height:5px;background:rgba(255,255,255,.04);border-radius:3px;overflow:hidden}
        .pf{width:0;height:100%;background:var(--grad);border-radius:3px;transition:width 1.2s cubic-bezier(.25,.46,.45,.94)}
        
        .gh{display:grid;grid-template-columns:1fr 1fr;gap:13px;margin-top:22px}
        .gc{border-radius:var(--rl);height:130px;position:relative;overflow:hidden;display:flex;flex-direction:column;justify-content:flex-end;padding:15px;cursor:pointer;background:var(--card2);background-size:cover;background-position:center;box-shadow:var(--sh)}
        .gc.full{grid-column: 1 / -1; height: 110px;}
        .gc::before{content:'';position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.88) 0%,rgba(0,0,0,.25) 55%,rgba(0,0,0,.08) 100%);z-index:1}
        .gc>div{position:relative;z-index:2}
        .gc.all-bg{background-image:url('https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?w=600&q=80'); background-position: top;}
        .gc.swipe-bg{background-image:url('https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=400&q=80');}
        .gc.similar-bg{background-image:url('https://images.unsplash.com/photo-1506157786151-b8491531f063?w=400&q=80');}
        .gc h3{font-size:12.5px;font-weight:500;margin-bottom:2px;opacity:.7}
        .gc p{font-size:21px;font-weight:700;letter-spacing:-.3px}
        .gc.full p{font-size:26px;}

        /* Media Grid (ã™ã¹ã¦) */
        .mg{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px}
        .mi{aspect-ratio:1/1;position:relative;background:var(--card2);overflow:hidden;cursor:pointer;}
        .mi img{width:100%;height:100%;object-fit:cover;display:block;}

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° --- */
        .preview-modal { position:absolute; inset:0; background:rgba(0,0,0,0.95); z-index:999; display:none; flex-direction:column; align-items:center; justify-content:center; opacity:0; transition:opacity 0.3s; }
        .preview-modal.show { display:flex; opacity:1; }
        .preview-img { max-width:100%; max-height:85%; object-fit:contain; border-radius:10px; }
        .preview-close { position:absolute; top:40px; right:20px; width:40px; height:40px; background:rgba(255,255,255,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:24px; cursor:pointer; backdrop-filter:blur(5px); }

        /* è¿½åŠ : ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .scan-spinner { width: 50px; height: 50px; border: 4px solid rgba(0, 184, 148, 0.2); border-top-color: var(--bright); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- ä¼¼ã¦ã„ã‚‹ç”»åƒ UI --- */
        .sim-group { background:var(--card); border:1px solid var(--bdr); border-radius:var(--rl); padding:15px; margin-bottom:20px; }
        .sim-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
        .sim-title { font-size:14px; font-weight:700; }
        .sim-size { font-size:12px; color:var(--bright); background:rgba(0,184,148,0.1); padding:4px 8px; border-radius:6px; font-weight:600; }
        .sim-scroll { display:flex; gap:12px; overflow-x:auto; padding-bottom:10px; scrollbar-width:none; }
        .sim-scroll::-webkit-scrollbar { display:none; }
        .sim-item { width:120px; flex-shrink:0; border-radius:var(--rm); aspect-ratio:4/5; position:relative; overflow:hidden; border:2.5px solid transparent; transition:all 0.2s; cursor:pointer; }
        .sim-item img { width:100%; height:100%; object-fit:cover; }
        .sim-item.best { border-color:var(--bright); }
        .sim-item.best .badge { position:absolute; top:8px; left:8px; background:var(--bright); color:#000; font-size:10px; font-weight:800; padding:4px 8px; border-radius:6px; z-index:2; }
        .sim-item.ck { border-color:var(--danger); }
        .sim-item.ck img { filter:brightness(0.6); }
        .chk-box { position:absolute; bottom:8px; right:8px; width:24px; height:24px; border:2px solid rgba(255,255,255,0.6); border-radius:50%; display:flex; justify-content:center; align-items:center; color:transparent; font-size:13px; font-weight:bold; z-index:10; background:rgba(0,0,0,0.35); }
        .sim-item.ck .chk-box { background:var(--danger); border-color:var(--danger); color:#fff; }

        /* --- æœˆåˆ¥ã‚¹ãƒ¯ã‚¤ãƒ— UI --- */
        .swipe-header-stats { display: flex; gap: 10px; margin-bottom: 20px; }
        .stat-box { flex: 1; background: var(--card); border: 1px solid var(--bdr); border-radius: var(--rm); padding: 12px; display: flex; align-items: center; gap: 10px; }
        .stat-ic { font-size: 24px; }
        .stat-v { font-size: 16px; font-weight: bold; }
        .stat-l { font-size: 10px; color: var(--sub); }
        .month-list { display: flex; flex-direction: column; gap: 12px; }
        .month-card { background: var(--card); border: 1px solid var(--bdr); border-radius: var(--rm); padding: 15px; display: flex; gap: 15px; align-items: center; cursor: pointer; transition: transform .2s; }
        .month-card:active { transform: scale(0.98); background: var(--card2); }
        .mc-thumb { width: 60px; height: 60px; border-radius: 10px; background-size: cover; background-position: center; flex-shrink: 0; position: relative; background-color: var(--dim); }
        .mc-thumb.done::after { content: 'âœ“'; position: absolute; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; font-size: 24px; color: #fff; border-radius: inherit; }
        .mc-info { flex: 1; }
        .mc-title { font-size: 16px; font-weight: bold; margin-bottom: 6px; display: flex; justify-content: space-between; }
        .mc-prog-text { font-size: 11px; color: var(--sub); margin-bottom: 4px; }
        .mc-prog-bar { width: 100%; height: 4px; background: rgba(255,255,255,0.06); border-radius: 2px; overflow: hidden; }
        .mc-prog-fill { height: 100%; background: var(--bright); border-radius: 2px; transition: width 0.3s; }

        #swipe-play { display: none; flex-direction: column; height: 100%; padding-bottom: 20px; }
        .sp-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .sp-prog-wrap { flex: 1; margin: 0 15px; }
        .sp-counts { font-size: 11px; color: var(--sub); text-align: right; margin-bottom: 4px; }
        .sp-img-container { flex: 1; background: var(--card); border-radius: var(--rl); position: relative; overflow: hidden; box-shadow: var(--sh); display: flex; align-items: center; justify-content: center; }
        .sp-img { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: var(--rl); transition: transform 0.3s ease, opacity 0.3s ease; }
        .swipe-left { transform: translateX(-100%) rotate(-10deg); opacity: 0; }
        .swipe-right { transform: translateX(100%) rotate(10deg); opacity: 0; }
        .sz-badge { position:absolute; bottom:15px; left:15px; background:var(--badge); backdrop-filter:blur(6px); color:#fff; font-size:14px; font-weight:700; padding:6px 12px; border-radius:10px; z-index:2; border:1px solid rgba(255,255,255,0.1); }
        .sp-actions { display: flex; justify-content: center; gap: 20px; margin-top: 25px; }
        .sp-btn { width: 72px; height: 72px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; transition: transform 0.1s; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .sp-btn:active { transform: scale(0.9); }
        .btn-dislike { background: var(--card); color: var(--danger); border: 2px solid var(--danger); }
        .btn-like { background: var(--card); color: var(--bright); border: 2px solid var(--bright); }

        /* --- çµæœ(ãƒªã‚¶ãƒ«ãƒˆ)ç”»é¢ --- */
        .res-container { display:flex; flex-direction:column; align-items:center; text-align:center; padding:20px 0; animation:fi .5s ease; }
        .res-icon { width:80px; height:80px; background:var(--grad); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:40px; margin-bottom:20px; box-shadow:0 10px 30px var(--glow); }
        .res-container h2 { font-size:22px; font-weight:700; margin-bottom:8px; }
        .res-container p { font-size:13px; color:var(--sub); margin-bottom:30px; }
        .res-stats { width:100%; display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:35px; }
        .rs-box { background:var(--card); border:1px solid var(--bdr); border-radius:var(--rm); padding:18px 10px; display:flex; flex-direction:column; align-items:center; }
        .rs-box.danger { border-color:rgba(255,71,87,0.3); background:linear-gradient(to bottom, var(--card), rgba(255,71,87,0.05)); }
        .rs-box span { font-size:11px; color:var(--sub); margin-bottom:6px; font-weight:600; }
        .rs-box strong { font-size:24px; font-weight:800; }
        .rs-box.danger strong { color:var(--danger); }
        .rs-box small { font-size:11px; color:var(--danger); margin-top:4px; font-weight:600; background:rgba(255,71,87,0.15); padding:3px 8px; border-radius:6px; }

        /* å‰Šé™¤ãƒãƒ¼ */
        .del-bar{position:absolute;bottom:80px;left:0;width:100%;padding:12px 20px;background:linear-gradient(to top,var(--bg) 70%,transparent);z-index:30;transform:translateY(110%);transition:transform .35s; display:flex;}
        .del-bar.show{transform:translateY(0)}

        .empty { display:none; flex-direction:column; align-items:center; justify-content:center; padding:60px 20px; text-align:center; }
        .e-ic { width:76px; height:76px; background:linear-gradient(135deg,rgba(0,93,77,.18),rgba(0,184,148,.08)); border:1px solid rgba(0,93,77,.18); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:34px; margin-bottom:18px; }
        
        nav{position:absolute;bottom:0;left:0;width:100%;height:78px;background:rgba(4,16,14,.94);backdrop-filter:blur(25px);-webkit-backdrop-filter:blur(25px);display:flex;justify-content:space-around;align-items:center;padding-bottom:18px;border-top:1px solid var(--bdr);z-index:40}
        .ni{display:flex;flex-direction:column;align-items:center;color:var(--dim);font-size:10px;cursor:pointer;transition:color .25s;padding:4px 10px;font-weight:500}
        .ni.on{color:var(--bright)}
        .nic{font-size:22px;margin-bottom:2px}
        .nd{width:4px;height:4px;border-radius:50%;background:var(--bright);margin-top:2px;opacity:0;transition:opacity .25s}
        .ni.on .nd{opacity:1}
    </style>
</head>
<body>
<div id="app">
    <header>
        <div class="h-top">
            <div id="back" class="back" onclick="goBack()">â€¹</div>
            <div id="act" class="h-act"></div>
            <div id="gear" class="gear">âš™</div>
        </div>
        <div class="h-tr">
            <div>
                <h1 style="display:inline-block;" id="title">ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸</h1>
                <span id="mode-badge" class="mode-badge">SAMPLE</span>
                <div id="sub" class="h-sub"></div>
            </div>
        </div>
    </header>

    <main id="home" class="view active">
        <div>
            <div class="sto-row">
                <div class="sto-u"><strong id="sto-txt">0 MB</strong> / èª­è¾¼æ¸ˆ</div>
                <div class="sto-p" id="sto-pct">---</div>
            </div>
            <div class="prog"><div class="pf" id="prog" style="width: 0%;"></div></div>

            <div class="access" id="access-panel">
                <div class="access-head">
                    <h4>ã‚¹ãƒãƒ›ã®å†™çœŸã‚’èª­ã¿è¾¼ã‚€</h4>
                    <p>å®Ÿéš›ã®å†™çœŸã‚’è¿½åŠ ã™ã‚‹ã‹ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã§<br>ã‚¢ãƒ—ãƒªã®å‹•ãã‚’ä½“é¨“ã§ãã¾ã™ã€‚</p>
                </div>
                <button class="a-btn" onclick="document.getElementById('fi-files').click()">
                    ğŸ“¸ è‡ªåˆ†ã®å†™çœŸã‚’è¿½åŠ ã™ã‚‹
                </button>
                <button class="a-btn secondary" id="demo-toggle-btn" style="margin-top:10px" onclick="toggleSampleMode()">
                    ğŸª„ ã‚µãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§ä½“é¨“
                </button>
                <input type="file" id="fi-files" class="file-in" accept="image/*,video/*" multiple onchange="handleFiles(this)">
            </div>

            <div class="gh" id="home-grid">
                <div class="gc full all-bg" onclick="navTo('all')">
                    <div><h3>ã™ã¹ã¦ã®å†™çœŸ</h3><p id="h-all-sz">0 MB</p><div class="cnt" id="h-all-cnt">0 æš</div></div>
                </div>
                <div class="gc swipe-bg" onclick="navTo('swipe')">
                    <div><h3>æœˆåˆ¥ã‚¹ãƒ¯ã‚¤ãƒ—</h3><p>æ•´ç†ã™ã‚‹</p></div>
                </div>
                <div class="gc similar-bg" onclick="navTo('similar')">
                    <div><h3>ä¼¼ã¦ã„ã‚‹å†™çœŸ</h3><p id="h-sim-txt">æœªæ¤œå‡º</p></div>
                </div>
            </div>
        </div>
    </main>

    <main id="all" class="view">
        <div id="all-grid" class="mg"></div>
        <div id="all-empty" class="empty" style="display:flex;"><div class="e-ic">âœ¨</div><h3>å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“</h3><p>ãƒ›ãƒ¼ãƒ ã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</p></div>
    </main>

    <main id="similar" class="view">
        <div id="similar-header-text">
            <p style="font-size:12px; color:var(--sub); margin-bottom:15px;">ä¸€ç•ªå·¦ã®ã€Œãƒ™ã‚¹ãƒˆã€ã‚’æ®‹ã—ã€2æšç›®ä»¥é™ã‚’å‰Šé™¤å€™è£œã¨ã—ã¦è‡ªå‹•é¸æŠã—ã¦ã„ã¾ã™ã€‚æ¨ªã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã¾ã™ã€‚</p>
        </div>
        <div id="similar-container">
            <div class="empty" style="display:flex; padding:20px;"><p>ç¾åœ¨ã€ä¼¼ã¦ã„ã‚‹å†™çœŸã¯æ¤œå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>ï¼ˆâ€»ã‚µãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§ãŠè©¦ã—ãã ã•ã„ï¼‰</p></div>
        </div>
    </main>

    <main id="swipe" class="view">
        <div id="swipe-list-view">
            <div class="swipe-header-stats">
                <div class="stat-box"><div class="stat-ic">ğŸ…</div><div><div class="stat-l">æ•´ç†æ¸ˆã¿</div><div class="stat-v" id="reward-cnt">0/0</div></div></div>
                <div class="stat-box"><div class="stat-ic">ğŸ§¹</div><div><div class="stat-l">è§£æ”¾ã—ãŸå®¹é‡</div><div class="stat-v" id="cleaned-sz">0 MB</div></div></div>
            </div>
            <div class="month-list" id="month-list-container">
                <div class="empty" style="display:flex; padding:20px;"><p>å†™çœŸã‚’è¿½åŠ ã™ã‚‹ã¨<br>ã“ã“ã«æœˆåˆ¥ã®ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p></div>
            </div>
        </div>

        <div id="swipe-play">
            <div class="sp-top">
                <div class="sp-prog-wrap">
                    <div class="sp-counts"><span id="sp-curr">0</span> / <span id="sp-total">0</span> ä»¶ã‚’ç¢ºèªæ¸ˆã¿</div>
                    <div class="mc-prog-bar"><div class="mc-prog-fill" id="sp-prog-bar" style="width: 0%;"></div></div>
                </div>
            </div>
            <div class="sp-img-container">
                <img id="sp-img" class="sp-img" src="" onclick="openPreview(this.src)">
                <div class="sz-badge" id="sp-size"></div>
            </div>
            <div class="sp-actions">
                <button class="sp-btn btn-dislike" onclick="handleSwipe('del')">ğŸ‘</button>
                <button class="sp-btn btn-like" onclick="handleSwipe('keep')">ğŸ‘</button>
            </div>
        </div>
    </main>

    <main id="results" class="view">
        <div class="res-container">
            <div class="res-icon">âœ¨</div>
            <h2>ã‚¹ãƒ¯ã‚¤ãƒ—å®Œäº†ï¼</h2>
            <p id="res-month-title"></p>
            
            <div class="res-stats">
                <div class="rs-box safe">
                    <span>æ®‹ã™å†™çœŸ</span>
                    <strong id="res-keep-cnt">0</strong>
                </div>
                <div class="rs-box danger">
                    <span>å‰Šé™¤ã™ã‚‹å†™çœŸ</span>
                    <strong id="res-del-cnt">0</strong>
                    <small id="res-del-sz">0 MB è§£æ”¾</small>
                </div>
            </div>
            
            <button class="a-btn danger" onclick="executeNativeDeleteMock()">ğŸ—‘ iPhoneã‹ã‚‰å‰Šé™¤ã™ã‚‹</button>
            <button class="a-btn secondary" style="margin-top:12px" onclick="goBackToSwipe()">ã‚ã¨ã§å‰Šé™¤ã™ã‚‹</button>
        </div>
    </main>

    <div id="del-bar" class="del-bar">
        <button class="a-btn danger" onclick="mockDeleteSimilar()"><span>ğŸ—‘</span> <span id="del-txt">å‰Šé™¤ã™ã‚‹</span></button>
    </div>

    <div id="preview-modal" class="preview-modal" onclick="closePreview()">
        <div class="preview-close">Ã—</div>
        <img id="preview-img" class="preview-img" src="" onclick="event.stopPropagation()">
    </div>

    <div id="loading-overlay" class="preview-modal" style="background:rgba(4,16,14,0.95);">
        <div class="scan-spinner"></div>
        <h3 style="color:#fff; margin-top:24px; font-size:18px;">èª­ã¿è¾¼ã¿ä¸­...</h3>
        <p id="loading-txt" style="color:var(--sub); font-size:13px; margin-top:8px;">0 / 0 æš</p>
    </div>

    <nav>
        <div class="ni on" data-t="home" onclick="navTo('home')"><div class="nic">ğŸ </div><span>ãƒ›ãƒ¼ãƒ </span><div class="nd"></div></div>
        <div class="ni" data-t="all" onclick="navTo('all')"><div class="nic">ğŸ“</div><span>ã™ã¹ã¦</span><div class="nd"></div></div>
        <div class="ni" data-t="swipe" onclick="navTo('swipe')"><div class="nic">ğŸƒ</div><span>ã‚¹ãƒ¯ã‚¤ãƒ—</span><div class="nd"></div></div>
        <div class="ni" data-t="similar" onclick="navTo('similar')"><div class="nic">ğŸ‘¯</div><span>é¡ä¼¼</span><div class="nd"></div></div>
    </nav>
</div>

<script>
// --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨çŠ¶æ…‹ç®¡ç† ---
let isSampleMode = false;

let realState = { globalFiles: [], swipeMonthsData: {}, totalInitialMB: 0, cleanedTotalMB: 0 };
let globalFiles = []; 
let swipeMonthsData = {}; 
let totalInitialMB = 0;
let cleanedTotalMB = 0;

let currentView = 'home';
let swipeActiveMonthKey = null;

const DEMO_URLS = [
    'https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?w=400&q=80',
    'https://images.unsplash.com/photo-1531306728370-53bfd6202e88?w=400&q=80',
    'https://images.unsplash.com/photo-1506157786151-b8491531f063?w=400&q=80',
    'https://images.unsplash.com/photo-1621360841013-c76831f1a301?w=400&q=80',
    'https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=400&q=80'
];

const DEMO_SIMILAR_DATA = [
    { id: 'g1', count: 3, saved: '5.2 MB', photos: [{ src: DEMO_URLS[0], isBest: true }, { src: DEMO_URLS[0]+'&blur=2', isBest: false }, { src: DEMO_URLS[0]+'&sepia=1', isBest: false }] },
    { id: 'g2', count: 2, saved: '3.8 MB', photos: [{ src: DEMO_URLS[2], isBest: true }, { src: DEMO_URLS[2]+'&blur=3', isBest: false }] }
];

// --- ã‚µãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ ---
function toggleSampleMode() {
    const btn = document.getElementById('demo-toggle-btn');
    const badge = document.getElementById('mode-badge');

    if (!isSampleMode) {
        isSampleMode = true;
        realState.globalFiles = [...globalFiles];
        realState.swipeMonthsData = Object.assign({}, swipeMonthsData);
        realState.totalInitialMB = totalInitialMB;
        realState.cleanedTotalMB = cleanedTotalMB;

        btn.innerHTML = 'âŒ ã‚µãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†';
        btn.classList.add('danger'); btn.classList.remove('secondary');
        badge.classList.add('show');

        loadSampleData();
    } else {
        isSampleMode = false;
        globalFiles = [...realState.globalFiles];
        swipeMonthsData = Object.assign({}, realState.swipeMonthsData);
        totalInitialMB = realState.totalInitialMB;
        cleanedTotalMB = realState.cleanedTotalMB;

        btn.innerHTML = 'ğŸª„ ã‚µãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§ä½“é¨“';
        btn.classList.add('secondary'); btn.classList.remove('danger');
        badge.classList.remove('show');

        refreshAllViews();
        navTo('home');
    }
}

function loadSampleData() {
    globalFiles = []; swipeMonthsData = {}; totalInitialMB = 0; cleanedTotalMB = 0;
    createDemoMonth('2026-02', '2026å¹´2æœˆ', 6);
    createDemoMonth('2026-01', '2026å¹´1æœˆ', 4);
    refreshAllViews();
}

function createDemoMonth(mKey, title, count) {
    if(!swipeMonthsData[mKey]) swipeMonthsData[mKey] = { id: mKey, title: title, total: 0, done: 0, photos: [], kept: [], deleted: [], savedMB: 0, isCleaned: false };
    for(let i=0; i<count; i++) {
        let sz = Math.round((Math.random() * 3 + 1)*10)/10;
        totalInitialMB += sz;
        let url = DEMO_URLS[i % DEMO_URLS.length];
        let photoObj = { id: 'demo_'+Math.random(), url: url, szMB: sz, monthKey: mKey };
        globalFiles.push(photoObj);
        swipeMonthsData[mKey].total++;
        swipeMonthsData[mKey].photos.push(photoObj);
    }
}

function refreshAllViews() {
    updateHomeStats(); renderAllPhotos(); renderSwipeList(); renderSimilar();
}

// --- â˜…ä¿®æ­£ç‰ˆï¼šéåŒæœŸãƒãƒ£ãƒ³ã‚¯å‡¦ç†ã«ã‚ˆã‚‹ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼ˆãƒ•ãƒªãƒ¼ã‚ºé˜²æ­¢ï¼‰ ---
async function handleFiles(inputElement) {
    const filesList = inputElement.files;
    if(!filesList.length) return;

    if (isSampleMode) toggleSampleMode();

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’è¡¨ç¤º
    const loader = document.getElementById('loading-overlay');
    const loaderTxt = document.getElementById('loading-txt');
    loader.classList.add('show');
    
    const total = filesList.length;
    let processed = 0;
    const chunkSize = 5; // 5ä»¶ãšã¤å‡¦ç†ã—ã¦ç”»é¢ã®ãƒ•ãƒªãƒ¼ã‚ºã‚’é˜²ã
    
    // FileListã‚’é…åˆ—ã«å¤‰æ›
    const filesArray = Array.from(filesList);

    for (let i = 0; i < total; i += chunkSize) {
        const chunk = filesArray.slice(i, i + chunkSize);

        // Promiseã¨setTimeoutã‚’ä½¿ã£ã¦ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’è§£æ”¾ï¼ˆãƒ•ãƒªãƒ¼ã‚ºå›é¿ã®è‚ï¼‰
        await new Promise(resolve => setTimeout(() => {
            for(let f of chunk) {
                if(f.type && !f.type.startsWith('image/') && !f.type.startsWith('video/')) continue;
                
                let d = f.lastModified ? new Date(f.lastModified) : new Date();
                let mKey = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                let sz = parseFloat((f.size / 1024 / 1024).toFixed(2));
                totalInitialMB += sz;
                
                let photoObj = { id: Math.random().toString(36).substr(2,9), url: URL.createObjectURL(f), szMB: sz, monthKey: mKey };
                globalFiles.push(photoObj);

                if(!swipeMonthsData[mKey]) {
                    swipeMonthsData[mKey] = { id: mKey, title: `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ`, total: 0, done: 0, photos: [], kept: [], deleted: [], savedMB: 0, isCleaned: false };
                }
                swipeMonthsData[mKey].total++;
                swipeMonthsData[mKey].photos.push(photoObj);
            }
            
            processed += chunk.length;
            loaderTxt.innerText = `${Math.min(processed, total)} / ${total} æšã‚’èª­ã¿è¾¼ã¿ä¸­...`;
            resolve();
        }, 10)); // 10msã®æ„å›³çš„ãªä¼‘ã¿ã‚’å…¥ã‚Œã¦UIãŒå›ºã¾ã‚‹ã®ã‚’é˜²ã
    }

    inputElement.value = ''; // é€£ç¶šã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯¾å¿œ
    refreshAllViews();
    
    // å‡¦ç†å®Œäº†ã—ãŸã‚‰ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éš ã—ã¦ã‚¹ãƒ¯ã‚¤ãƒ—ç”»é¢ã¸
    loader.classList.remove('show');
    navTo('swipe'); 
}

// --- ç”»é¢é·ç§»ãƒ­ã‚¸ãƒƒã‚¯ ---
function navTo(id) {
    document.querySelectorAll('.ni').forEach(x => x.classList.remove('on'));
    const tab = document.querySelector(`.ni[data-t="${id}"]`);
    if(tab) tab.classList.add('on');
    go(id);
}

function go(id) {
    currentView = id;
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    
    const titles = { home:'ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸', all:'ã™ã¹ã¦ã®å†™çœŸ', swipe:'å†™çœŸã‚’ã‚¹ãƒ¯ã‚¤ãƒ—', similar:'ä¼¼ã¦ã„ã‚‹å†™çœŸ', results:'æ•´ç†çµæœ' };
    document.getElementById('title').innerText = titles[id] || id;

    const backBtn = document.getElementById('back');
    const gearBtn = document.getElementById('gear');
    const delBar = document.getElementById('del-bar');
    
    if (id === 'home' || id === 'swipe' || id === 'results') {
        backBtn.style.display = 'none'; gearBtn.style.display = 'flex';
        delBar.classList.remove('show');
        if (id === 'swipe') {
            document.getElementById('swipe-list-view').style.display = 'block';
            document.getElementById('swipe-play').style.display = 'none';
        }
    } else {
        backBtn.style.display = 'block'; gearBtn.style.display = 'none';
        if(id === 'similar') updateDelBar();
        else delBar.classList.remove('show');
    }
}

function goBack() {
    if (document.getElementById('swipe-play').style.display === 'flex') {
        navTo('swipe'); renderSwipeList();
    } else { navTo('home'); }
}
function goBackToSwipe() { navTo('swipe'); renderSwipeList(); }

function updateHomeStats() {
    let currentTotalMB = globalFiles.reduce((sum, p) => sum + p.szMB, 0);
    document.getElementById('h-all-sz').innerText = currentTotalMB.toFixed(1) + ' MB';
    document.getElementById('h-all-cnt').innerText = globalFiles.length + ' æš';
    document.getElementById('sto-txt').innerText = currentTotalMB.toFixed(1) + ' MB';
    document.getElementById('sto-pct').innerText = globalFiles.length > 0 ? 'èª­è¾¼æ¸ˆ' : '---';
    let pct = totalInitialMB > 0 ? (currentTotalMB / totalInitialMB) * 100 : 0;
    document.getElementById('prog').style.width = pct + '%';
}

function renderAllPhotos() {
    const grid = document.getElementById('all-grid');
    grid.innerHTML = globalFiles.map(p => `
        <div class="mi" onclick="openPreview('${p.url}')"><img src="${p.url}" loading="lazy"></div>
    `).join('');
    document.getElementById('all-empty').style.display = globalFiles.length ? 'none' : 'flex';
}

function openPreview(url) {
    document.getElementById('preview-img').src = url;
    document.getElementById('preview-modal').classList.add('show');
}
function closePreview() {
    document.getElementById('preview-modal').classList.remove('show');
    setTimeout(() => { document.getElementById('preview-img').src = ''; }, 300);
}

function renderSwipeList() {
    const cont = document.getElementById('month-list-container');
    const monthsArr = Object.values(swipeMonthsData).sort((a,b) => b.id.localeCompare(a.id));
    if(monthsArr.length === 0) {
        cont.innerHTML = `<div class="empty" style="display:flex; padding:20px;"><p>å†™çœŸã‚’è¿½åŠ ã™ã‚‹ã¨<br>ã“ã“ã«æœˆåˆ¥ã®ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p></div>`;
        document.getElementById('reward-cnt').innerText = `0/0`;
        document.getElementById('cleaned-sz').innerText = `0 MB`;
        return;
    }
    
    let compCount = 0;
    cont.innerHTML = monthsArr.map(m => {
        const pct = (m.done / m.total) * 100;
        const isComp = m.done === m.total;
        if(m.isCleaned) compCount++;
        const thumbUrl = m.photos.length > 0 ? m.photos[0].url : '';
        return `
            <div class="month-card" onclick="startSwipe('${m.id}')">
                <div class="mc-thumb ${m.isCleaned ? 'done' : ''}" style="background-image:url('${thumbUrl}')"></div>
                <div class="mc-info">
                    <div class="mc-title"><span>${m.title}</span></div>
                    <div class="mc-prog-text">${m.done}/${m.total} ä»¶ã‚’ç¢ºèªæ¸ˆã¿</div>
                    <div class="mc-prog-bar"><div class="mc-prog-fill" style="width: ${pct}%"></div></div>
                </div>
            </div>
        `;
    }).join('');
    document.getElementById('reward-cnt').innerText = `${compCount}/${monthsArr.length}`;
    document.getElementById('cleaned-sz').innerText = `${cleanedTotalMB.toFixed(1)} MB`;
}

function startSwipe(monthKey) {
    const month = swipeMonthsData[monthKey];
    if (month.isCleaned) { alert("ã“ã®æœˆã¯ã™ã§ã«å‰Šé™¤å®Œäº†ã—ã¦ã„ã¾ã™ã€‚"); return; }
    if (month.done >= month.total) { showResults(monthKey); return; }
    
    swipeActiveMonthKey = monthKey;
    document.getElementById('title').innerText = month.title;
    document.getElementById('back').style.display = 'block';
    document.getElementById('swipe-list-view').style.display = 'none';
    document.getElementById('swipe-play').style.display = 'flex';
    updateSwipeCard();
}

function updateSwipeCard() {
    const month = swipeMonthsData[swipeActiveMonthKey];
    document.getElementById('sp-curr').innerText = month.done;
    document.getElementById('sp-total').innerText = month.total;
    document.getElementById('sp-prog-bar').style.width = ((month.done / month.total) * 100) + '%';
    
    if (month.done >= month.total) { setTimeout(() => showResults(swipeActiveMonthKey), 400); return; }
    
    const currentImg = month.photos[month.done];
    const imgEl = document.getElementById('sp-img');
    imgEl.className = 'sp-img'; 
    setTimeout(() => {
        imgEl.src = currentImg.url;
        document.getElementById('sp-size').innerText = currentImg.szMB + " MB";
    }, 50);
}

function handleSwipe(action) {
    const imgEl = document.getElementById('sp-img');
    const month = swipeMonthsData[swipeActiveMonthKey];
    const currentImg = month.photos[month.done];
    
    if (action === 'del') {
        imgEl.classList.add('swipe-left');
        month.deleted.push(currentImg);
        month.savedMB += currentImg.szMB;
    } else {
        imgEl.classList.add('swipe-right');
        month.kept.push(currentImg);
    }
    month.done += 1;
    setTimeout(() => updateSwipeCard(), 300);
}

function showResults(monthKey) {
    const month = swipeMonthsData[monthKey];
    document.getElementById('res-month-title').innerText = `${month.title} ã®æ•´ç†ãŒçµ‚ã‚ã‚Šã¾ã—ãŸ`;
    document.getElementById('res-keep-cnt').innerText = `${month.kept.length} æš`;
    document.getElementById('res-del-cnt').innerText = `${month.deleted.length} æš`;
    document.getElementById('res-del-sz').innerText = `${month.savedMB.toFixed(1)} MB è§£æ”¾å¯èƒ½`;
    go('results');
}

function executeNativeDeleteMock() {
    const month = swipeMonthsData[swipeActiveMonthKey];
    if(month.deleted.length === 0) {
        alert("å‰Šé™¤ã™ã‚‹å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“ï¼ç´ æ™´ã‚‰ã—ã„æ•´ç†æ•´é “ã§ã™ã€‚");
        month.isCleaned = true; goBackToSwipe(); return;
    }

    if(confirm(`"${month.title}" ã®å†™çœŸ ${month.deleted.length}æš ã‚’iPhoneã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n(iOSé€£æºã®ãƒ‡ãƒ¢)`)) {
        const deletedIds = month.deleted.map(p => p.id);
        globalFiles = globalFiles.filter(p => !deletedIds.includes(p.id));
        cleanedTotalMB += month.savedMB;
        month.isCleaned = true;
        
        refreshAllViews();
        alert(`âœ¨ å‰Šé™¤å®Œäº†ï¼\nå®¹é‡ãŒ ${month.savedMB.toFixed(1)} MB å¢—ãˆã¾ã—ãŸã€‚`);
        goBackToSwipe();
    }
}

// --- ä¼¼ã¦ã„ã‚‹å†™çœŸ æ©Ÿèƒ½ ---
function renderSimilar() {
    const cont = document.getElementById('similar-container');
    const headerText = document.getElementById('similar-header-text');
    
    if (!isSampleMode) {
        headerText.style.display = 'none';
        cont.innerHTML = `<div class="empty" style="display:flex; padding:20px;"><p>ç¾åœ¨ã€ä¼¼ã¦ã„ã‚‹å†™çœŸã¯æ¤œå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>ï¼ˆâ€»ã€Œã‚µãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§ä½“é¨“ã€ã‚’ãŠè©¦ã—ãã ã•ã„ï¼‰</p></div>`;
        document.getElementById('h-sim-txt').innerText = 'æœªæ¤œå‡º';
        return;
    }

    headerText.style.display = 'block';
    document.getElementById('h-sim-txt').innerText = 'ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿';
    cont.innerHTML = DEMO_SIMILAR_DATA.map(g => {
        const items = g.photos.map(p => `
            <div class="sim-item ${p.isBest ? 'best' : 'ck to-del'}" onclick="toggleSimItem(this)">
                ${p.isBest ? '<div class="badge">KEEP</div>' : ''}
                <img src="${p.src}" onclick="event.stopPropagation(); openPreview(this.src)">
                <div class="chk-box">âœ“</div>
            </div>
        `).join('');
        return `<div class="sim-group" id="${g.id}"><div class="sim-header"><span class="sim-title">é¡ä¼¼å†™çœŸ ${g.count}æš</span><span class="sim-size">${g.saved} è§£æ”¾</span></div><div class="sim-scroll">${items}</div></div>`;
    }).join('');
}

function toggleSimItem(el) {
    if(el.classList.contains('best')) { alert("ã“ã‚Œã¯ãƒ™ã‚¹ãƒˆã‚·ãƒ§ãƒƒãƒˆã§ã™ã€‚"); return; }
    el.classList.toggle('ck'); updateDelBar();
}

function updateDelBar() {
    const ckCount = document.querySelectorAll('.sim-item.ck').length;
    const bar = document.getElementById('del-bar');
    if (ckCount > 0 && currentView === 'similar') {
        document.getElementById('del-txt').innerText = `${ckCount} æšã‚’iPhoneã‹ã‚‰å‰Šé™¤`;
        bar.classList.add('show');
    } else {
        bar.classList.remove('show');
    }
}

function mockDeleteSimilar() {
    const ckItems = document.querySelectorAll('.sim-item.ck');
    if(confirm(`${ckItems.length}æšã®å†™çœŸã‚’iPhoneã‹ã‚‰å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        ckItems.forEach(el => { el.style.transform = 'scale(0)'; el.style.opacity = '0'; setTimeout(() => el.remove(), 300); });
        setTimeout(() => { alert("å‰Šé™¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"); updateDelBar(); }, 400);
    }
}

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', () => {
    refreshAllViews();
});
</script>
</body>
</html>
